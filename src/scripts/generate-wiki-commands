#!/bin/bash
#
# "$1" is usage.cfg
# "$2" is output file

DIR="$(cd "$(dirname "$0")" && pwd)"
SRC_DIR="$DIR/.."

cat <<EOF > "$2"
This page was automatically generated from the source of Red Eclipse, please do not edit it manually.

{| border="1" class="wikitable sortable"
! Name&nbsp;&&nbsp;Parameters
! class="unsortable"|Description
! Type
EOF

IFS=$'\n'
for i in $(grep "^setdesc" "$1" | sort)
do
    COM="$(echo $i | sed -n 's%^setdesc "\([^"]*\)".*%\1%p')"

    # Get corresponding source lines
    SRC_DEF="$(grep -hr "^[^A-Z]*[A-Z]*COMMAND[A-Z]*([^,]*, $COM, " "$SRC_DIR")"
    if [ -z "$SRC_DEF" ]; then continue; fi

    DESC="$(echo $i | sed -e 's%^setdesc "[^"]*" "\(.*\)".*%\1%' -e 's%" "<.*%%' -e 's%\^%%g')"
    PARAM="$(echo $i | sed -n 's%^setdesc "[^"]*" ".*" "\([^"]*\)"%\1%p')"

    SRC_IDF="$(echo $SRC_DEF | sed 's%^[^A-Z]*[A-Z]*COMMAND[A-Z]*(\([^,]*\),%\1%')"
    IDF_ADMIN=""
    # Currently only one case
    case "$SRC_IDF" in
        *IDF_ADMIN*)
            IDF_ADMIN="admin-only"
            ;;
    esac

    TYPE_STRING="$(echo "$IDF_ADMIN command" | sed -e 's%^ *%%' -e 's%  *% %g')"

    cat <<EOF >> "$2"
|-
| '''$COM'''&nbsp;''$PARAM''
| $DESC
| $TYPE_STRING
EOF
    done

sed 's%&nbsp;['\'']*$%%' -i "$2"

echo "|}" >> "$2"
