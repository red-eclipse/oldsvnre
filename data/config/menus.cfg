// standard menu definitions

bind ESCAPE [if (cleargui 1) [] [showgui main]]    // it all starts here

vardef =  [guitext $arg2 ; [@[arg1]val] = $$arg1]
varhdef = [guitext $arg2 ; [@[arg1]val] = (hexcolour $$arg1)]
varfld =  [varname = [@[arg1]val] ; guifield $varname $arg2 [@arg1 $@varname]]
varbit =  [varname = [@[arg1]val] ; guibitfield "" $arg2 [@arg1 $@varname]]

vardef2 = [
    guitext $arg2
    [@[arg1]val1] = $[@[arg1]1]
    [@[arg1]val2] = $[@[arg1]2]
]
varhdef2 = [
    guitext $arg2
    [@[arg1]val1] = (hexcolour $[@[arg1]1])
    [@[arg1]val2] = (hexcolour $[@[arg1]2])
]
varfld2 = [guilist [
    varname1 = [@[arg1]val1]
    guifield $varname1 $arg2 [[@@[arg1]1] $@varname1]
    varname2 = [@[arg1]val2]
    guifield $varname2 $arg2 [[@@[arg1]2] $@varname2]
]]
varbit2 = [guilist [
    varname1 = [@[arg1]val1]
    guibitfield "" $varname1 $arg2 [[@@[arg1]1] $@varname1]
    varname2 = [@[arg1]val2]
    guibitfield "" $varname2 $arg2 [[@@[arg1]2] $@varname2]
]]
varincr = [guilist [
    varname1 = [@[arg1]val1]
    guibutton "^fy-" [[@@[arg1]1] (- $@varname1 1)]
    guifield $varname1 $arg2 [[@@[arg1]1] $@varname1]
    guibutton "^fg+" [[@@[arg1]1] (+ $@varname1 1)]
    varname2 = [@[arg1]val2]
    guifield $varname2 $arg2 [[@@[arg1]2] $@varname2]
]]

weapcollidevars = ["traced" "hit proj" "hit owner" "impact geom" "impact plyr" "impact shot" "bounce geom" "bounce plyr" "bounce shot" "drill geom" "drill plyr" "drill shot" "stick geom" "stick plyr"]

guibox = [
    guilist [
        guilist [
            guispring 1
            if (> @numargs 0) arg1
            guispring 1
        ]
        guistrut 1
        guicenter [
            guistrut 50 1
            if (> @numargs 1) arg2
        ]
    ]
]

guimerge = [ guibody [guilist [guilist [guistrut $arg1]; guilist [arg2]]] $arg3 $arg4 ]
guiarea = [
    guilist [
        if (> $numargs 9) arg10
        guilist [
            [@[arg1]count] = $arg2
            [@[arg1]disp] = 0
            [@[arg1]list] = 0
            guilist [
                guistrut 0.5
                guistrut $arg3 1
                if (arg5) [
                    [@[arg1]num] = $arg6
                    if (> $[@[arg1]num] 0) [
                        [@[arg1]index] = (min (max 0 (- $[@[arg1]num] $[@[arg1]count])) $[@[arg1]index]) //safeguard
                        loop i $[@[arg1]num] [
                            arg7
                            if (arg8) [
                                if (&& (>= $i $[@[arg1]index]) (< $[@[arg1]list] $[@[arg1]count])) [
                                    if (> $numargs 10) arg11
                                    [@[arg1]list] = (+ $[@[arg1]list] 1)
                                ]
                                [@[arg1]disp] = (+ $[@[arg1]disp] 1)
                            ]
                        ]
                    ] [guistrut (-f (*f $arg4 $arg2) 1); if (> $numargs 8) arg9; [@[arg1]list] = $arg2]
                ] [guistrut (-f (*f $arg4 $arg2) 1); if (> $numargs 8) arg9; [@[arg1]list] = $arg2]
                [@[arg1]alts] = (- $[@[arg1]count] $[@[arg1]list])
                if (> $[@[arg1]alts] 0) [guistrut (*f $[@[arg1]alts] $arg4)]
            ]
            guistrut 2
            guislider [@[arg1]index] 0 (max (- $[@[arg1]disp] $[@[arg1]count]) 0) [] 1 1
        ]
        if (> $numargs 11) arg12
    ]
]
guipage = [ guistayopen [guiarea $arg1 $arg2 $arg3 $arg4 $arg5 $arg6 $arg7 $arg8 $arg9 $arg10 $arg11 $arg12] ]
guicontainer = [ guilist [ guilist [ if (arg1) [arg2] [arg3] ] ] ]
guiright = [ guilist [ guispring 1; if (> $numargs 0) arg1 ] ]
guicenter = [ guilist [ guispring 1; if (> $numargs 0) arg1; guispring 1 ] ]

guitip = [
    nonworld [
        guistayopen [
            guicenter [
                guibody [
                    guilist [
                        guifont "reduced" [ guitext "TIP: " ]
                        guifont "little" [ guitext (format "^fa%1" (? (> @@@@@numargs 0) [@@@@@arg1] (showtip))) ]
                    ]
                ] [lasttip = 0] [lasttip = 0]
            ]
        ]
    ]
]

newgui main [
    guitip
    guistrut 0.5
    guibox [guiimage "textures/emblem" "showgui servers" 7.5 1 "textures/nothumb"] [
        guifont "default" [
            guicenter [ guibutton "profile" "showgui profile" ]
            guistrut 0.5
            if (isconnected) [
                if (= (gamemode) $modeidxediting) [
                    guicenter [ guibutton "editing" "showgui editing" ]
                    guistrut 0.5
                ]
                guicenter [ guibutton "disconnect" "disconnect" ]
                if (> (getvote) 0) [ guicenter [ guibutton "show votes" "showgui maps 2" ] ]
                guistrut 0.5
            ]
            guicenter [ guibutton (? (isonline) "find servers" "play online") "showgui servers" ]
            guicenter [ guibutton (? (isconnected) "vote map/mode" "offline practice") "showgui maps 1" ]
            guistrut 0.5
            if (> (ircconns) 0) [ guicenter [ guibutton "irc windows" "showgui irc" ] ]
            guicenter [ guibutton "options" "showgui options" ]
            guicenter [ guibutton "variables" "showgui vars" ]
            guicenter [ guibutton "help" "showgui help" ]
            guistrut 0.5
            guicenter [ guibutton "quit" "quit" ]
        ]
    ]
    guistrut 0.5
    guilist [
        guistrut 0.5
        guilist [
            guifont "little" [
                cases (? (strlen $guirolloverimgaction) $guirolloverimgaction $guirolloveraction) "showgui servers" [
                    guitext "displays the server browser for other online matches"
                ] "showgui profile" [
                    guitext "edit your name, colour, and model type"
                ] "showgui editing" [
                    guitext "access commands to use while editing a map"
                ] "showgui irc" [
                    guitext "shows your open irc windows"
                ]  "disconnect" [
                    guitext "disconnects your current connection"
                ] "showgui maps 2" [
                    guitext "displays the current votes"
                ] "showgui maps 1" [
                    guitext (format "select a map/mode combination to %1" (? (isonline) "vote for" "practice on"))
                ] "showgui options" [
                    guitext "edit your configuration options"
                ] "showgui vars" [
                    guitext "edit gameplay and weapon variables"
                ] "showgui help" [
                    guitext "gets some help!"
                ] "quit" [
                    guitext "closes Red Eclipse"
                ] () [
                    guitext "click on an activity to start"
                ]
            ]
        ]
    ]
]

guimodes = [
    guicenter [ guitext (modedesc @arg1 @arg2 5) ]
    if (> $arg2 0) [
        loop i $mutsidxnum [
            mut = (<< 1 $i)
            if (& $arg2 $mut) [
                desc = (mutsdesc $arg1 $mut 4)
                if (strlen $desc) [ guicenter [ guitext (concatword "^fa" [@desc]) ] ]
            ]
        ]
    ]
]

newgui loading [
    nonworld [ guistayopen [ guinohitfx [
        guitip
        guistrut 0.5
        guilist [
            guiimage "" [] 7.5 1
            guistrut 1
            guicenter [
                guistrut 50 1
                guifont "emphasis" [ guicenter [ guitext (? (strlen $maptitle) $maptitle "Loading..") ] ]
                guifont "default" [
                    guicenter [ guitext (? (strlen $maptitle) (concat "^faby" (? (strlen $mapauthor) $mapauthor "Unknown")) "Please wait..") ]
                ]
                guifont "little" [
                    if (strlen $connectname) [ guicenter [ guitext (format "^faon: ^fw%1:[%2]" $connectname $connectport) ] ]
                    if (isconnected) [
                        gname = (gamename (gamemode) (mutators))
                        if (> (strlen $gname) 32) [ gname = (gamename (gamemode) (mutators) 1) ]
                        guicenter [ guitext (format "playing: [ ^fs^fa%1^fS ]" $gname) ]
                        guicenter [
                            modetexs = (modetexlist (gamemode) (mutators))
                            looplist modetex $modetexs [ guiimage $modetex [] 1 0 "textures/blank" ]
                        ]
                        guimodes (gamemode) (mutators)
                    ]
                ]
            ]
        ]
    ] ] ]
]

ircident = 0

newgui irc [
    guistayopen [
        guitext "saved identities"
        guislider ircident 0 10
        guilist [
            guilist [
                guitext "network  "
                guitext "address  "
                guitext "port     "
                guitext "nickname "
                guitext "channel  "
            ]
            guilist [
                guilist [
                    guifield ircname@ircident -40
                    guistrut 1
                    guibutton "connect" [
                        ircaddclient $[ircname@ircident] $[irchost@ircident] $[ircport@ircident] $[ircnick@ircident]
                        ircaddchan $[ircname@ircident] $[ircchan@ircident]
                    ]
                ]
                guifield [irchost@ircident] -40
                guifield [ircport@ircident] -40
                guifield [ircnick@ircident] -40
                guilist [
                    guifield [ircchan@ircident] -40
                    guistrut 1
                    guibutton "join" [ ircaddchan $[ircname@ircident] $[ircchan@ircident] ]
                ]
            ]
        ]
    ]
    guibar
    ircgui
] [
    if (= $guipasses 0) [
        ircname0 = freenode
        irchost0 = irc.freenode.net
        ircport0 = 6667
        ircnick0 = (filter (getplayername) 1 1 0)
        ircchan0 = #redeclipse
    ]
]

newgui about [
    guibox [guiimage "textures/emblem" "cleargui 1" 7.5 1 "textures/nothumb"] [
        guicenter [ guitext "Red Eclipse Engine" ]
        guifont "little" [
            guicenter [ guitext "(C) 2010-2013 Quinton Reeves, Lee Salzman" ]
            guicenter [ guitext "http://www.redeclipse.net/" ]
        ]
        guistrut 1
        guicenter [ guitext "Red Eclipse Data" ]
        guifont "little" [
            guicenter [ guitext "(C) 2010-2013 Red Eclipse Team" ]
            guicenter [ guitext "http://www.redeclipse.net/" ]
        ]
        guistrut 1
        guicenter [ guitext "Based on Cube Engine 2" ]
        guifont "little" [
            guicenter [ guitext "(C) 2001-2013 Wouter van Oortmerssen, Lee Salzman" ]
            guicenter [ guitext "Mike Dysart, Robert Pointon, and Quinton Reeves" ]
            guicenter [ guitext "http://sauerbraten.org/" ]
        ]
    ]
]

newgui support [
    ircgui freenode
] [
    if (= $guipasses 0) [
        ircaddclient freenode irc.freenode.net 6667 (getplayername)
        ircaddchan freenode #redeclipse
    ]
]

newgui help [
    guibox [guiimage "textures/emblem" "cleargui 1" 7.5 1 "textures/nothumb"] [
        guifont "default" [
            guicenter [ guibutton "about" "showgui about" ]
            guicenter [ guibutton "live support" "showgui support" ]
        ]
    ]
]

resetmapgui = 0
shownservergui = 0
mapselected = 0
mutsselected = 0
modeselected = -1
mutsbefore = 0
lastmode = -1
lastmuts = 0

newgui profile [
    guibox [guiplayerpreview $modlval $colrval $teamval $weapval $vntyval [cleargui 1] 7.5 1 (? (strcmp $versionuname "mekarcade") 0.75 1)] [
        guilist [
            guicenter [
                guicenter [
                    guitext "name:  "
                    guifield nameval 24 []
                ]
                guistrut 0.5
                guicenter [
                    if (strcmp $versionuname "mekarcade") [
                        guitext "mek:"
                        guistrut 4
                        guicenter [
                            guilist [ guistrut 20 ]
                            guislider modlval 0 3
                        ]
                    ] [
                        guitext "model: "
                        guiradio "male" modlval 0
                        guistrut 1
                        guiradio "female" modlval 1
                    ]
                ]
                guistrut 1
                guicenter [
                    colr = (& (>> $colrval 16) 0xFF)
                    colg = (& (>> $colrval 8) 0xFF)
                    colb = (& $colrval 0xFF)
                    guilist [
                        guibackground $colrval
                        guistrut 6 1
                        guistrut 3
                    ]
                    guistrut 1
                    guilistsplit n 3 "0 1 2" [
                        guilist [
                            guistrut 30 1
                            guislider col@(at "r g b" $n) 0 255 [
                                colrval = (| (| (<< $colr 16) (<< $colg 8)) $colb)
                            ] 0 1 0x@(at "FF0000 00FF00 0000FF" $n)
                        ]
                    ]
                ]
            ]
            if (! (strcmp $versionuname "mekarcade")) [
                guistrut 2
                guicenter [
                    vanitynum = (getvanity)
                    loop z $vanitynum [
                        vaint = (getvanity $z 1)
                        found = (>= (indexof $vntyval $vaint) 0)
                        guistayopen [ guibutton (getvanity $z 2) [
                            vntyval = ( @(? $found listdel concat) $vntyval @(escape $vaint) )
                        ] [] (? $found "checkboxon" "checkbox") ]
                    ]
                ]
            ]
        ]
        guistrut 1
        guicenter [ guifont "super" [
            guibutton "^fgok" [setinfo $nameval $colrval $modlval $vntyval; cleargui 1] [] "action"
            guispring 1
            guibutton "^focancel" [cleargui 1] [] "exit"
        ] ]
        guistrut 1
        guitext $vntyval
    ]
    guitab "account"
    guibox [guiplayerpreview $modlval $colrval $teamval $weapval $vntyval [cleargui 1] 7.5 1 (? (strcmp $versionuname "mekarcade") 0.75 1)] [
        guifont "emphasis" [ guicenter [ guitext "Red Eclipse Account" ] ]
        guistrut 1
        guicenter [
            guitext "user: "
            guifield accountname 48 []
        ]
        guicenter [
            guitext "pass: "
            guifield accountpass 48 []
        ]
        guistrut 1
        guicenter [
            guicheckbox "identify on connect" authconnect
        ]
    ]
    guitab "view options"
    guibox [guiplayerpreview $modlval $colrval $teamval $weapval $vntyval [cleargui 1] 7.5 1 (? (strcmp $versionuname "mekarcade") 0.75 1)] [
        guicenter [ guifont "reduced" [ guitext "player colour tones" ] ]
        guistrut 0.5
        guicenter [
            guilistsplit n 2 "0 1" [ guispring 1; guilist [ guilist [ guitext (format "%1: " (at "primary secondary" $n)) ]; guistrut 1 ] ]
            guilistsplit n 2 "0 1" [
                guilist [
                    guistrut 30 1
                    guislider player@(at "overtone undertone" $n) -1 6 [] 0 1
                    guifont "consub" [
                        case $player@(at "overtone undertone" $n) -1 [
                            guitext "^faprofile colour overrides all, no tones applied"
                        ] 0 [
                            guitext "^fateam colours only, profile not used"
                        ] 1 [
                            guitext "^faprofile colour regardless of team"
                        ] 2 [
                            guitext "^faprofile colour when neutral, team when teamed"
                        ] 3 [
                            guitext "^faneutral colour when neutral, profile when teamed"
                        ] 4 [
                            guitext "^faprofile colour mixed with team"
                        ] 5 [
                            guitext "^faprofile colour mixed with team (but neutral)"
                        ] 6 [
                            guitext "^faprofile colour overrides team, only neutral is mixed"
                        ]
                    ]
                ]
            ]
        ]
        guistrut 1
        guicenter [
            guicenter [
                guicenter [ guifont "reduced" [ guitext "preview options" ] ]
                guistrut 0.5
                guicenter [
                    teamneutraltex = $teamtex
                    loop t 5 [
                        push t (at "neutral alpha omega kappa sigma" $t) [
                            guistayopen [ guifont "default" [ guibutton (format "^f[%1]^f(%2)" $[team@[t]colour] $[team@[t]tex]) [teamval = @@@@t] ] ]
                        ]
                    ]
                ]
                guistrut 0.25
                guicenter [
                    loop w $weapidxnum [
                        push w (at $weapname $w) [
                            guistayopen [ guifont "emphasis" [ guibutton (format "^f[%1]^f(%2)" $[@[w]colour] [textures/weapons/@w]) [weapval = @@@@w] ] ]
                        ]
                    ]
                ]
            ]
        ]
    ]
] [
    if (= $guipasses 0) [
        teamval = 0
        weapval = 0
        nameval = (getplayername)
        colrval = (getplayercolour -1)
        modlval = (getplayermodel)
        vntyval = (getplayervanity)
    ]
]

loadweaplist = ""
loadweapsave = 0
loadweapall = 0; setpersist loadweapall 1

loadweaps = [
    lwa = ""
    lwo = (? (> (listlen $loadweaplist) $arg1) (at $loadweaplist $arg1) 0)
    loop w2 (min (listlen $loadweaplist) $weapidxloadout) [
        if (= $w2 $arg1) [
            lwa = (? $w2 (concat $lwa $arg2) $arg2)
        ] [
            w3 = (? (> (listlen $loadweaplist) $w2) (at $loadweaplist $w2) 0)
            if (&& $w3 (= $arg2 $w3)) [ w3 = $lwo ]
            lwa = (? $w2 (concat $lwa $w3) $w3)
        ]
    ]
    if (listlen $lwa) [ loadweaplist = $lwa ]
]

newgui loadout [
    guitip (format "press ^fs^fc%1^fS to open this menu at any time" (searchbinds "showgui loadout" 5 "or" "^fw"))
    guibox [guiimage "textures/emblem" "cleargui 1" 7.5 1 "textures/nothumb"] [
        if (hasloadweap) [
            guifont "reduced" [ guicenter [ guitext "choose loadout weapons" ] ]
            guistrut 0.5
            guifont "reduced" [
                guicenter [
                    guilist [
                        guiright [ guitext "^fa^f(textures/question)random" ]
                        loop w1 $weapidxloadout [
                            w4 = (+ $w1 $weapidxoffset)
                            push w1 (at $weapname $w4) [
                                guiright [ guitext (format "^f[%1]^f(%2)%3" $[@[w1]colour] [textures/weapons/@w1] $[@[w1]name]) ]
                            ]
                        ]
                    ]
                    guistayopen [
                        cnt = (? $loadweapall $weapidxloadout $maxcarry)
                        loop w2 $cnt [
                            w3 = (? (> (listlen $loadweaplist) $w2) (at $loadweaplist $w2) 0)
                            guistrut 0.5
                            guilist [
                                hi = (> (+ $w2 1) $maxcarry)
                                guiimage (? (= $w3 0) (? $hi "textures/checkboxtwo" "textures/checkboxon") "textures/checkbox") [loadweaps @w2 0] 0.5 0 "textures/blank"
                                loop w1 $weapidxloadout [
                                    w4 = (+ $w1 $weapidxoffset)
                                    if (allowedweap $w4) [
                                        guiimage (? (= $w3 $w4) (? $hi "textures/checkboxtwo" "textures/checkboxon") "textures/checkbox") [loadweaps @w2 @w4] 0.5 0 "textures/blank"
                                    ] [ guiimage "textures/checkdisable" [] 0.5 0 "textures/blank" ]
                                ]
                            ]
                        ]
                    ]
                ]
            ]
            guistrut 0.5
            guicenter [ guicenter [
                guifont "little" [
                    guicenter [ guicheckbox "show all slots" loadweapall ]
                    guicenter [
                        guicenter [ guicheckbox "save for future use" loadweapsave ]
                        if (listlen $favloadweaps) [
                            guistrut 1
                            guicenter [ guistayopen [ guibutton "[^fs^frreset^fS]" [ favloadweaps "" ] ] ]
                        ]
                    ]
                    guicenter [ guicheckbox "automatically use saved loadout" autoloadweap 1 0 [
                        if (&& $autoloadweap (listlen $favloadweaps)) [ loadweapsave = 1 ]
                    ] ]
                ]
            ] ]
            guistrut 0.4
            guicenter [
                guifont "reduced" [ guibutton "^focancel" [cleargui 1] ]
                guispring 1
                guifont "default" [ guibutton "^fgsubmit" [loadweap $loadweaplist $loadweapsave] ]
            ]
        ] [
            guifont "default" [ guicenter [ guitext "sorry" ] ]
            guistrut 1
            guifont "reduced" [ guicenter [ guitext "^frweapon selection is not currently available" ] ]
            guistrut 1
            guifont "default" [ guicenter [ guibutton "^foclose window" [cleargui 1] ] ]
        ]
    ]
] [
    if (= $guipasses 0) [
        loop i $weapidxloadout [ loadweaplist = (? $i (concat $loadweaplist (getloadweap $i)) (getloadweap $i)) ]
        loadweapsave = 0
    ]
]

newgui team [
    guitip (format "press ^fs^fc%1^fS to open this menu at any time" (searchbinds "showgui team" 5 "or" "^fw"))
    guibox [guiimage "textures/emblem" "cleargui 1" 7.5 1 "textures/nothumb"] [
        guifont "default" [ guicenter [ guitext "choose team" ] ]
        guistrut 1
        if (!= (getplayerstate) 4) [
            guicenter [ guibutton (format "^fw^f(%1) spectate" $spectex) [spectator 1] ]
            guistrut 1
        ]
        guifont "reduced" [
            if (&& [>= (gamemode) $modeidxstart] [! (& (mutators) $mutsbitcoop)] (|| [! (& (mutators) $mutsbitffa)] [& (mutators) $mutsbitmulti])) [
                loop t (? (& (mutators) $mutsbitmulti) 4 2) [
                    push t (at "alpha omega kappa sigma" $t) [
                        guicenter [ guibutton (format "^f[%1]^f(%2) %3" $[team@[t]colour] $[team@[t]tex] $[team@[t]name]) [team @t] ]
                    ]
                ]
            ] [
                guicenter [ guitext "there are no teams you can join" ]
            ]
        ]
        guistrut 1
        guifont "default" [ guicenter [ guibutton "^focancel" [cleargui 1] [] "action" ] ]
    ]
]

maplists = [ campaignmaps mainmaps capturemaps defendmaps bombermaps trialmaps ]
mapindex = 0
lastmode = -1
lastmuts = 0
mapnum = -1
mapcur = ""
mappth = ""
maplist = ""
mappath = ""
mapextra = ""
mapimg = ""
mapocta = 0
mapfavs = ""; setpersist mapfavs 1
demofavs = ""; setpersist demofavs 1
resetmapgui = 0

mapsmenuinit = [
    if (isconnected) [
        modeselected = (gamemode)
        if (< (mutators) 0) [ mutsselected = 0 ] [ mutsselected = (mutscheck $modeselected (mutators)) ]
    ] [
        modeselected = -1
        mutsselected = 0
    ]
    mapindex = 0
    lastmode = -1
    lastmuts = 0
    mapnum = -1
    mapcur = ""
    mappth = ""
    maplist = ""
    mappath = ""
    mapextra = ""
    mapimg = ""
    mapocta = 0
    resetmapgui = 1
    mutsbefore = $mutsselected
]

mapsmenuiter = [
    if (|| [!= $lastmode $modeselected] [!= $lastmuts $mutsselected]) [ resetmapgui = 1 ]
    if (= $resetmapgui 1) [
        maprot = 0
        maplist = ""
        mappath = ""
        if (= $modeselected $modeidxdemo) [
            mutsselected = 0
            loop q 2 [
                loopfiles lcurmap demos dmo [
                    if (? $q (< (listfind xcurmap $demofavs [strcmp $xcurmap $lcurmap]) 0) (>= (listfind xcurmap $demofavs [strcmp $xcurmap $lcurmap]) 0)) [
                        append maplist $lcurmap
                        append mappath [demos/@lcurmap]
                    ]
                ]
            ]
            maprot = (listlen $maplist)
            append maplist "?"
            append mappath "?"
        ] [
            mutsselected = (mutscheck $modeselected $mutsselected)
            if (>= $modeselected $modeidxplay) [
                curlist = (getmaplist $modeselected $mutsselected (? (isonline) (listlen (listclients 1)) 0))
                curprev = (sublist $prevmaps 0 $maphistory)
                loop q 2 [
                    looplist lcurmap $curlist [
                        if (< (listfind pcurmap $curprev [strcmp $pcurmap $lcurmap]) 0) [
                            if (? $q (< (listfind xcurmap $mapfavs [strcmp $xcurmap $lcurmap]) 0) (>= (listfind xcurmap $mapfavs [strcmp $xcurmap $lcurmap]) 0)) [
                                append maplist $lcurmap
                                append mappath [maps/@lcurmap]
                            ]
                        ]
                    ]
                ]
                maprot = (listlen $maplist)
                wantlist = 1
                looplist lcurmap $curprev [
                    if $wantlist [
                        append maplist "~"
                        append mappath "~"
                        wantlist = 0
                    ]
                    append maplist $lcurmap
                    append mappath [maps/@lcurmap]
                ]
            ] [ maprot = 0 ]
            wantlist = 1
            loop q 2 [
                loopfiles lcurmap maps mpz [
                    if (< (listfind mcurmap $maplist [strcmp $mcurmap $lcurmap]) 0) [
                        if (? $q (< (listfind xcurmap $mapfavs [strcmp $xcurmap $lcurmap]) 0) (>= (listfind xcurmap $mapfavs [strcmp $xcurmap $lcurmap]) 0)) [
                            if $wantlist [
                                append maplist "*"
                                append mappath "*"
                                wantlist = 0
                            ]
                            append maplist $lcurmap
                            append mappath [maps/@lcurmap]
                        ]
                    ]
                ]
            ]
            if (&& [> $mapocta 0] [> $hasoctapaks 0]) [
                wantlist = 1
                loop q 2 [
                    loopfiles lcurmap base ogz [
                        if (? $q (< (listfind xcurmap $mapfavs [strcmp $xcurmap $lcurmap]) 0) (>= (listfind xcurmap $mapfavs [strcmp $xcurmap $lcurmap]) 0)) [
                            if $wantlist [
                                append maplist "."
                                append mappath "."
                                wantlist = 0
                            ]
                            append maplist $lcurmap
                            append mappath [base/@lcurmap]
                        ]
                    ]
                ]
            ]
            append maplist "?"
            append mappath "?"
            mapnum = (listfind curmap $maplist [
                || [=s $curmap $mapcur] [=s [maps/@curmap] $mapcur] [
                    && [> $hasoctapaks 0] [> $mapocta 0] [=s [base/@curmap] $mapcur]
                ]
            ])
        ]
        mapcount = (listlen $maplist)
        if (! $maprot) [ maprot = $mapcount ]
        if (|| [< $mapnum 0] [>= $mapnum $maprot]) [ mapnum = (rnd $maprot) ]
        lastmode = $modeselected
        lastmuts = $mutsselected
        mapindex = 0
        resetmapgui = 0
    ]
    if (=s (at $maplist $mapnum) "?") [
        mapcur = $mapextra
        if (= $modeselected $modeidxdemo) [
            mappth = [demos/@mapcur]
            mapdmo = (demoscan (format "%1.dmo" $mappth))
            mapimg = (? (>= $mapdmo 0) (format "maps/%1" (demoinfo $mapdmo 2)) "textures/emblem")
        ] [
            mappth = $mapextra
            mapimg = $mapextra
        ]
    ] [
        mapcur = (at $maplist $mapnum)
        mappth = (at $mappath $mapnum)
        if (= $modeselected $modeidxdemo) [
            mapdmo = (demoscan (format "%1.dmo" $mappth))
            mapimg = (? (>= $mapdmo 0) (format "maps/%1" (demoinfo $mapdmo 2)) "textures/emblem")
        ] [
            mapimg = (at $mappath $mapnum)
        ]
    ]
]

mutsvar = [
    local g m s t
    guistayopen [ guilist [
        g = $$arg2
        m = $$arg3
        s = $$arg5
        if (& (mutsimplied $g $m) $arg4) [
            guibutton $arg1 [ implied = @arg4 ] [] "checkboxtwo"
        ] [
            if (|| (& (mutscheck $g (| $m $arg4) $arg4) $arg4) (! (ismodelocked $g $m $arg4 $s))) [
                t = (& $m $arg4)
                guibutton $arg1 [
                    mutate = @arg4
                    if @t [@@arg3 = @@(mutscheck $g (- $m $arg4))] [
                        @@arg3 = @@(mutscheck $g (| $m $arg4) $arg4)
                    ]
                ] [] (? $t "checkboxon" "checkbox")
            ] [ guibutton $arg1 [ disabled = @arg4 ] [] "checkdisable" ]
        ]
    ] ]
]

modevar = [
    local g m s
    guistayopen [ guilist [
        g = $$arg2
        m = $$arg3
        s = $$arg5
        if (ismodelocked $g $m 0 $s) [ guibutton $arg1 [ disabled = @arg4 ] [] "checkdisable" ] [
            guibutton $arg1 [@arg2 = @arg4] [] (? (= $$arg2 $arg4) "checkboxon" "checkbox")
        ]
    ] ]
]

mapsexec = [
    sleep 1 [
        if (isconnected) [ showgui maps 2 ]
        start @arg1 @arg2 @arg3
    ]
]

mapsmenu = [
    guilist [
        guistrut 74 1
        guitip (format "press ^fs^fc%1^fS to open this menu at any time" (searchbinds "showgui maps 1" 5 "or" "^fw"))
        guistrut 0.5
        guilist [
            guilist [
                guilist [
                    guistrut 3 1
                    guilist [
                        if (< $lastmode 0) [
                            guitext "game select"
                            guifont "little" [ guitext "please select a mode and map to continue" ]
                        ] [
                            gname = (gamename $modeselected $mutsselected)
                            if (> (strlen $gname) 32) [ gname = (gamename $modeselected $mutsselected 1) ]
                            guilist [
                                guitext $gname
                                if (= $modeselected $modeidxdemo) [
                                    dinfo = (demoscan (format "%1.dmo" $mappth))
                                    dmode = (demoinfo $dinfo 3)
                                    dmuts = (demoinfo $dinfo 4)
                                    dname = (gamename $dmode $dmuts)
                                    if (> (strlen $dname) 32) [ dname = (gamename $dmode $dmuts 1) ]
                                    guifont "little" [ guitext (format " (%1)" $dname) ]
                                ]
                            ]
                            guilist [
                                guitext " ^faselected on ";
                                guitext $mapcur
                                if (= $modeselected $modeidxdemo) [
                                    dinfo = (demoscan (format "%1.dmo" $mappth))
                                    dmapname = (demoinfo $dinfo 2)
                                    guifont "little" [ guitext (format " (%1)" $dmapname) ]
                                ]
                            ]
                        ]
                    ]
                ]
                guilist [
                    guilist [
                        guitext "mode"
                        guistrut 0.5
                        guifont "little" [
                            loop z $modeidxnum [
                                modevar (at $modename $z) modeselected mutsselected $z mapcur
                            ]
                        ]
                    ]
                    guistrut 3
                    guilist [
                        guistayopen [
                            guiimage $mapimg [if (>= @lastmode 0) [ mapsexec @mapcur @modeselected @mutsselected ]] 5 1 "textures/emblem"
                        ]
                    ]
                ]
                guistrut 0.5
                guifont "reduced" [
                    guilist [
                        guitext "mutators"
                        guispring
                        guistayopen [ guibutton "^fyreset selection" [ mutsselected = (mutscheck $modeselected 0) ] ]
                        guispring
                    ]
                ]
                guistrut 0.5
                guifont "little" [
                    cnt = (- $mutsidxnum $mutsidxgsn)
                    guiloopsplit n 3 $cnt [
                        mutsvar (at $mutsname $n) modeselected mutsselected (<< 1 $n) mapcur
                    ] [ guistrut 3 ]
                ]
                if (> (strlen (gspmutname $modeselected 0)) 0) [
                    guistrut 0.5
                    guifont "little" [ guitext "mode specific" ]
                    guistrut 0.5
                    guifont "little" [
                        guiloopsplit n 3 $mutsidxgsn [
                            mut = (gspmutname $modeselected $n)
                            if (strlen $mut) [
                                mutsvar $mut modeselected mutsselected (<< 1 (+ $mutsidxgsp $n)) mapcur
                            ]
                        ] [ guistrut 3 ]
                    ]
                ]
            ]
            guistrut 1
            mapscount = 21
            guilist [
                guilist [
                    guitext "available maps"
                    if (> $hasoctapaks 0) [
                        guispring
                        guistayopen [
                            guibutton "show sauer maps" [
                                mapocta = (! $mapocta)
                                resetmapgui = 1
                            ] [] (? (> $mapocta 0) "checkboxon" "checkbox")
                        ]
                        guispring 1
                        guitext "fav"
                        guistrut 3
                    ]
                ]
                guistrut 0.25
                guilist [
                    guifont "little" [
                        guicontainer [>= $lastmode 0] [
                            nummaps = (- (listlen $maplist) 1)
                            guilist [
                                guilist [
                                    guistrut $mapscount 1
                                    mapindex = (min (max 0 (- $nummaps $mapscount)) $mapindex) //safeguard
                                    mapnum = (min $mapnum $nummaps)
                                    guilist [
                                        guistrut 37 1
                                        break = 0
                                        loopwhile i $mapscount [= $break 0] [
                                            q = (+ $mapindex $i)
                                            curmap = (at $maplist $q)
                                            cases $curmap "*" [
                                                guifont "little" [ guitext "maps not in the rotation" ]
                                            ] "~" [
                                                guifont "little" [ guitext "maps played recently" ]
                                            ] "." [
                                                guifont "little" [ guitext "maps from sauerbraten" ]
                                            ] "?" [
                                                break = 1
                                            ] () [
                                                guilist [
                                                    guiradio $curmap mapnum $q
                                                    guispring 1
                                                    guistayopen [
                                                        hasmap = (>= (indexof (? (= $modeselected $modeidxdemo) $demofavs $mapfavs) $curmap) 0)
                                                        guiimage (? $hasmap "textures/checkboxon" "textures/checkbox") [
                                                            if (= $modeselected $modeidxdemo) [
                                                                demofavs = (? @hasmap (listdel $demofavs @curmap) (concat (listdel $demofavs @curmap) @curmap))
                                                            ] [
                                                                mapfavs = (? @hasmap (listdel $mapfavs @curmap) (concat (listdel $mapfavs @curmap) @curmap))
                                                            ]
                                                            resetmapgui = 1
                                                        ] 0.5 0 "textures/blank"
                                                    ]
                                                ]
                                            ]
                                        ]
                                    ]
                                ]
                                guilist [ guifont "little" [ guitext "^custom map" ] ]
                                guilist [
                                    guiradio "" mapnum $nummaps
                                    mapextraval = $mapextra
                                    guifield mapextraval 36 [mapextra = $mapextraval]
                                ]
                            ]
                            guislider mapindex 0 (max (- $nummaps $mapscount) 0) [] 1 1
                        ] [
                            guistrut 40
                            guistrut (+f $mapscount 3.5) 1
                        ]
                    ]
                ]
            ]
        ]
        guistrut 0.25
        guilist [
            if (>= $lastmode 0) [
                guispring 1
                guifont "super" [
                    guistayopen [ guibutton (? (isonline) "^fgsubmit vote" "^fgstart game") [ mapsexec $mapcur $modeselected $mutsselected ] ]
                ]
                guistrut 15
            ] [guistrut 1]
        ]
        guistrut 0.25
        guilist [
            guistrut 0.5
            guilist [
                guifont "small" [
                    act = (? (strlen $guirolloverimgaction) $guirolloverimgaction $guirolloveraction)
                    cases (at $act 0) "modeselected" [
                        guitext (format "%1" (modedesc (at $act 2) $mutsselected 3))
                    ] "mutate" [
                        guitext (format "%1" (mutsdesc $modeselected (at $act 2) 3))
                    ] "implied" [
                        guitext "this mutator is implied in the current configuration"
                    ] "disabled" [
                        guitext "this mutator is disabled in the current configuration"
                    ] () [guitext "hover over a mode or mutator to see its description"]
                ]
            ]
        ]
    ]
]

voteindex = 0
votenum = 0
votemenuinit = [ voteindex = 0 ]

votemenu = [
    guipage vote 6 72 4.2 [1] (getvote) [
        voteplayers = (getvote $i 0)
        votemode = (getvote $i 1)
        votemuts = (getvote $i 2)
        votemap = (getvote $i 3)
        voteself = 0
        loop j $voteplayers [ if (= (getclientnum) (getvote $i 0 $j)) [ voteself = 1 ] ]
    ] [1] [
        guibutton "^fwThere are no votes currently pending, ^fgsubmit ^fwone yourself" [showgui maps 1] [] "chat"
    ] [
        guitip (format "press ^fs^fc%1^fS to open this menu at any time" (searchbinds "showgui maps 2" 5 "or" "^fw"))
        guistrut 0.5
        guilist [
            guicheckbox "^fcdynamic sort" sortvotes; guistrut 1.5
            guicheckbox "^focleanup list" cleanvotes; guistrut 1.5
            guibutton "^fyclear vote" clearvote
            guispring
            guitext (format "^fd[ ^fc%1 ^fwvote%2 ^fd]" $votenum (? (!= $votenum 1) "s"))
            guistrut 1
        ]
        guistrut 0.25
    ] [
        guistrut 0.125
        guimerge 72 [
            guilist [
                guistrut 1.25
                guistrut 4.5 1
                votecolour = (? $voteself "^fy" "^fw")
                guifont "default" [guibutton (concatword $votecolour $voteplayers)]
                guifont "little" [guibutton (format "%1vote%2" $votecolour (? (!= $voteplayers 1) "s"))]
            ]
            voteimage = "textures/chat"
            votepath = (listfind curmap $maplist [|| [=s $curmap $votemap] [=s [maps/@curmap] $votemap] [
                && [> $mapocta 0] [> $hasoctapaks 0] [=s [base/@curmap] $votemap]
            ]])
            if (> $votepath -1) [ voteimage = (at $mappath $votepath) ]
            guiimage $voteimage "" 2 1 "textures/chat"
            guistrut 1
            guilist [
                guistrut 0.5
                gname = (gamename $votemode $votemuts)
                if (> (strlen $gname) 32) [ gname = (gamename $votemode $votemuts 1) ]
                guifont "reduced" [ guibutton (format "^fy%1" $gname) ]
                guistrut 0.125
                guilist [
                    guistrut 2
                    guifont "little" [ guibutton " ^favoted for on " ]
                    guifont "reduced" [ guibutton (format "^fo%1" $votemap) ]
                ]
                guilist [
                    if (> $voteplayers 0) [
                        guifont "reduced" [ guibutton "^fwby " ]
                        pname = ""
                        pmore = 0
                        loop j $voteplayers [
                            if (> (strlen $pname) 64) [ pmore = (+ $pmore 1) ] [
                                append pname (format ["%1"] (getclientname (getvote $i 0 $j) 1))
                            ]
                        ]
                        guifont "little" [ guibutton (concat (prettylist $pname) (? $pmore (concat "and^fy" $pmore "^fwmore"))) ]
                    ] [ guifont "reduced" [ guibutton "^fano current votes" ] ]
                ]
            ]
        ] [
            if (= @voteself 1) [ clearvote ] [ start @@votemap @@votemode @@votemuts ]
        ] []
        guistrut 0.125
    ]
]

newgui maps [
    octapaks [
        mapsmenuiter
        guilist [ mapsmenu ]
        guitab "votes"
        guilist [ votemenu ]
    ]
] [
    if (= $guipasses 0) [
        octapaks [ mapsmenuinit; votemenuinit ]
    ]
]

varslist1 = [ rotatemaps spawnrotate selfdamage trialstyle teamdamage spawnhealth maxhealth maxhealthvampire actorscale minresizescale maxresizescale maxcarry regenhealth kamikaze pointlimit capturelimit captureresetdelay ]
varslist2 = [ defendlimit defendpoints defendoccupy defendflags bomberlimit bomberresetdelay bomberspeed gamespeed gravityforce liquidspeedforce liquidcoastforce floorcoastforce aircoastforce slidecoastforce movespeed movecrawl movesprint movejet movestraight movestrafe moveinair movestepup movestepdown jumpspeed impulsespeed impulselimit impulseboost ]
varslist3 = [ impulsedash impulsejump impulsemelee impulseparkour impulseparkournorm impulseallowed impulsestyle impulsecount impulsedelay impulseslide impulsemeter impulsecost impulseskate impulsesprint impulsejet impulseregen impulseregencrouch impulseregensprint impulseregenjet impulseregenmove impulseregeninair damagescale criticalchance ]
varslist4 = [ itemsallowed hitpushscale hitslowscale deadpushscale wavepushscale waveslowscale timelimit triallimit intermlimit votelimit duelreset duelclear duellimit itemspawntime itemspawndelay itemspawnstyle itemthreshold regendelay regentime enemyspawntime enemyspawndelay enemyspawnstyle spawngrenades spawnweapon instaweapon ]

varsmenu = [
    guifont "little" [
        guilist [
            guilistsplit n 4 "1 2 3 4" [
                guilist [
                    guilist [ looplist var $[varslist@n] [vardef $var $var] ]
                    guistrut 2
                    guilist [ looplist var $[varslist@n] [varfld $var 8] ]
                ]
                if (= $n 4) [
                    guistrut 0.5
                    guilist [guistayopen [
                        guistrut 4
                        guibutton "^foreset all game variables" [resetvars]
                    ]]
                ]
            ] [guistrut 3]
        ]
    ]
]

weapindex = 0
weapmenuinit = [ weapindex = 0 ]
weapindexdelta = [
    weapindex = (+ $weapindex $arg1)
    if (< $weapindex 0) [ weapindex = (+ $weapindex $weapidxnum) ]
    if (>= $weapindex $weapidxnum) [ weapindex = (- $weapindex $weapidxnum) ]
]

weapmenu = [
    guistayopen [
        guilist [
            weap = (getweap $weapindex -1)
            guilist [
                guiimage (getweap $weapindex 1) [weapindexdelta 1] 1.25 0 "textures/nothumb"
                guistrut 0.5
                guilist [
                    guifont default [ guitext [@weap (@[weapindex]/@(+ $weapindex $weapidxnum))] ]
                    guilist [
                        guibutton "^fo<prev" [weapindexdelta -1]
                        guistrut 1
                        guibutton "^fynext>" [weapindexdelta 1]
                    ]
                ]
            ]
            guistrut 1
            guifont "little" [
                guilist [
                    guilist [
                        vardef   [@[weap]name]    "name"
                        varhdef  [@[weap]colour]  "colour"
                        varhdef2 [@[weap]partcol] "partcol"
                        varhdef2 [@[weap]explcol] "explcol"
                        vardef   [@[weap]add]     "add"
                        vardef   [@[weap]max]     "max"
                        vardef2  [@[weap]sub]     "reduced"
                        vardef2  [@[weap]attackdelay]  "attackdelay"
                        vardef   [@[weap]reloaddelay]  "reloaddelay"
                        vardef2  [@[weap]damage]  "damage"
                        vardef2  [@[weap]speed]   "speed"
                        vardef2  [@[weap]power]   "power"
                        vardef2  [@[weap]time]    "time"
                        vardef2  [@[weap]projdelay]  "projdelay"
                        vardef2  [@[weap]guideddelay]  "guideddelay"
                        vardef2  [@[weap]escapedelay]  "escapedelay"
                        vardef2  [@[weap]explode] "explode"
                    ]
                    guistrut 2
                    guilist [
                        varfld  [@[weap]name]    16
                        varfld  [@[weap]colour]  16
                        varfld2 [@[weap]partcol] 7
                        varfld2 [@[weap]explcol] 7
                        varfld  [@[weap]add]     16
                        varfld  [@[weap]max]     16
                        varfld2 [@[weap]sub]     7
                        varfld2 [@[weap]attackdelay]  7
                        varfld  [@[weap]reloaddelay]  16
                        varfld2 [@[weap]damage]  7
                        varfld2 [@[weap]speed]   7
                        varfld2 [@[weap]power]   7
                        varfld2 [@[weap]time]    7
                        varfld2 [@[weap]projdelay]  7
                        varfld2 [@[weap]guideddelay]  7
                        varfld2 [@[weap]escapedelay]  7
                        varfld2 [@[weap]explode] 7
                    ]
                ]
            ]
        ]
        guistrut 2
        guifont "little" [
            guilist [
                guilist [
                    guilist [
                        vardef2 [@[weap]rays]         "rays"
                        vardef2 [@[weap]spread]       "spread"
                        vardef2 [@[weap]zdiv]         "zdiv"
                        vardef2 [@[weap]aiskew]       "aiskew"
                        vardef2 [@[weap]fragweap]     "fragweap"
                        vardef2 [@[weap]flakdamage]   "flakdamage"
                        vardef2 [@[weap]fragrays]     "fragrays"
                        vardef2 [@[weap]fragtime]     "fragtime"
                        vardef2 [@[weap]fragspeed]    "fragspeed"
                        vardef2 [@[weap]cooked]       "cooked"
                        vardef2 [@[weap]guided]       "guided"
                        vardef2 [@[weap]extinguish]   "extinguish"
                        vardef2 [@[weap]radial]       "radial"
                        vardef2 [@[weap]residual]     "residual"
                        vardef  [@[weap]reloads]      "reloads"
                        vardef  [@[weap]carried]      "carried"
                        vardef  [@[weap]zooms]        "zooms"
                        vardef2 [@[weap]fullauto]     "fullauto"
                        vardef  [@[weap]allowed]      "allowed"
                        vardef2 [@[weap]critdash]     "critdash"
                        vardef2 [@[weap]taperin]      "taperin"
                        vardef2 [@[weap]taperout]     "taperout"
                        vardef2 [@[weap]elasticity]   "elasticity"
                        vardef2 [@[weap]reflectivity] "reflectivity"
                        vardef2 [@[weap]relativity]   "relativity"
                    ]
                    guistrut 2
                    guilist [
                        varfld2 [@[weap]rays]         7
                        varfld2 [@[weap]spread]       7
                        varfld2 [@[weap]zdiv]         7
                        varfld2 [@[weap]aiskew]       7
                        varfld2 [@[weap]fragweap]     7
                        varfld2 [@[weap]fragdamage]   7
                        varfld2 [@[weap]fragrays]     7
                        varfld2 [@[weap]fragtime]     7
                        varfld2 [@[weap]fragspeed]    7
                        varfld2 [@[weap]cooked]       7
                        varfld2 [@[weap]guided]       7
                        varfld2 [@[weap]extinguish]   7
                        varfld2 [@[weap]radial]       7
                        varfld2 [@[weap]residual]     7
                        varfld  [@[weap]reloads]      16
                        varfld  [@[weap]carried]      16
                        varfld  [@[weap]zooms]        16
                        varfld2 [@[weap]fullauto]     7
                        varfld  [@[weap]allowed]      16
                        varfld2 [@[weap]critdash]     7
                        varfld2 [@[weap]taperin]      7
                        varfld2 [@[weap]taperout]     7
                        varfld2 [@[weap]elasticity]   7
                        varfld2 [@[weap]reflectivity] 7
                        varfld2 [@[weap]relativity]   7
                    ]
                ]
            ]
            guistrut 3
            guilist [
                guilist [
                    guilist [
                        vardef2 [@[weap]waterfric]  "waterfric"
                        vardef2 [@[weap]weight]     "weight"
                        vardef2 [@[weap]radius]    "radius"
                        vardef2 [@[weap]kickpush]   "kickpush"
                        vardef2 [@[weap]hitpush]    "hitpush"
                        vardef2 [@[weap]slow]       "slow"
                        vardef2 [@[weap]aidist]     "aidist"
                        vardef2 [@[weap]partsize]   "partsize"
                        vardef2 [@[weap]partlen]    "partlen"
                        vardef  [@[weap]frequency]  "frequency"
                        vardef2 [@[weap]wavepush]   "wavepush"
                        vardef  [@[weap]critmult]   "critmult"
                        vardef  [@[weap]critdist]   "critdist"
                        vardef2 [@[weap]delta]      "delta"
                        vardef2 [@[weap]trace]      "trace"
                        vardef2 [@[weap]headmin]    "headmin"
                        vardef2 [@[weap]whipdamage]  "whipdamage"
                        vardef2 [@[weap]torsodamage] "torsodamage"
                        vardef2 [@[weap]legdamage]  "legdamage"
                        vardef2 [@[weap]fragscale]  "fragscale"
                        vardef2 [@[weap]fragspread] "fragspread"
                        vardef2 [@[weap]fragrel]    "fragrel"
                        vardef2 [@[weap]fragjump]   "fragjump"
                        vardef2 [@[weap]fragoffset] "fragoffset"
                        vardef2 [@[weap]fragskew]   "fragskew"
                    ]
                    guistrut 2
                    guilist [
                        varfld2 [@[weap]waterfric]  7
                        varfld2 [@[weap]weight]     7
                        varfld2 [@[weap]radius]     7
                        varfld2 [@[weap]kickpush]   7
                        varfld2 [@[weap]hitpush]    7
                        varfld2 [@[weap]slow]       7
                        varfld2 [@[weap]aidist]     7
                        varfld2 [@[weap]partsize]   7
                        varfld2 [@[weap]partlen]    7
                        varfld  [@[weap]frequency]  16
                        varfld2 [@[weap]wavepush]   7
                        varfld  [@[weap]critmult]   16
                        varfld  [@[weap]critdist]   16
                        varfld2 [@[weap]delta]      7
                        varfld2 [@[weap]trace]      7
                        varfld2 [@[weap]headmin]    7
                        varfld2 [@[weap]whipdamage]    7
                        varfld2 [@[weap]torsodamage]   7
                        varfld2 [@[weap]legdamage]    7
                        varfld2 [@[weap]fragscale]  7
                        varfld2 [@[weap]fragspread] 7
                        varfld2 [@[weap]fragrel]    7
                        varfld2 [@[weap]fragjump]   7
                        varfld2 [@[weap]fragoffset] 7
                        varfld2 [@[weap]fragskew]   7
                    ]
                ]
            ]
            guistrut 3
            guilist [
                loop n 2 [
                    guilist [
                        push n (at "collide flakcollide" $n) [
                            guilist [
                                vardef2 [@[weap]@n] (format "^fw%1" (at [collision: "flak collision:"] @@n))
                                looplist a $weapcollidevars [guitext $a]
                            ]
                            guistrut 2
                            guilist [
                                guitext "^fwpri^fa/^fwalt"
                                loop b (listlen $weapcollidevars) [
                                    varbit2 [@[weap]@n] (<< 1 $b)
                                ]
                            ]
                        ]
                    ]
                    if (= $n 0) [guistrut 2]
                ]
            ]
        ]
    ]
]

newgui vars [
    guilist [ varsmenu ]
    guitab "weap"
    guilist [ weapmenu ]
] [
    if (= $guipasses 0) [
        weapmenuinit
    ]
]

sinfoindex = 0
sinfowait = 0
sinforetry = ""
sinfopass = ""
sinfonum = 0
sinfodisp = 0
sinfoplayers = 0
sinfonumsrv = 0

sinfotypes = [ "" "status" "name" "port" "qport" "desc" "mode" "muts" "map" "time" "players" "maxplayers" "ping" ]
sinfomodify = [
    sinfotlist = $arg1
    sinfotabsl = (? (> $sinfotlist 0) $sinfotlist (- 0 $sinfotlist))
    loop i (listlen $serversort) [
        sinfostype = (at $serversort $i)
        if $sinfostype [
            sinfosabsl = (? (> $sinfostype 0) $sinfostype (- 0 $sinfostype))
            if (!= $sinfotabsl $sinfosabsl) [ append sinfotlist $sinfostype ]
        ]
    ]
    serversort $sinfotlist
]


servermenuinit = [
    sinfoindex = 0
    sinfowait = 0
    sinforetry = ""
    sinfopass = ""
    sinfoplayers = 0
    sinfonumsrv = 0
    shownservergui = 0
    updateservergui = 0
]
servermenuiter = [
    if (! $shownservergui) [
        maplist = ""
        mappath = ""
        loopfiles lcurmap maps mpz [
            if (< (listfind mcurmap $maplist [=s $mcurmap $lcurmap]) 0) [
                append maplist $lcurmap
                append mappath [maps/@lcurmap]
            ]
        ]
        if (> $hasoctapaks 0) [
            loopfiles lcurmap base ogz [
                append maplist $lcurmap
                append mappath [base/@lcurmap]
            ]
        ]
        shownservergui = 1
    ]
]
servermenu = [
    guipage sinfo 5 88 4.2 [getserver] (getserver) [
        sinfostat = (getserver $i 0 0)
        sinfoname = (getserver $i 0 1)
        sinfoport = (getserver $i 0 2)
        sinfonpid = [@[sinfoname]:[@@sinfoport]]
        sinfodesc = (getserver $i 0 3)
        sinfomapn = (getserver $i 0 4)
        sinfonump = (getserver $i 0 5)
        sinfoplayers = (? $i (+ $sinfoplayers $sinfonump) $sinfonump)
        sinfoping = (getserver $i 0 6)
        sinfolast = (getserver $i 0 7)
        sinfogver = (getserver $i 1 0)
        sinfomode = (getserver $i 1 1)
        sinfomuts = (getserver $i 1 2)
        sinfotime = (getserver $i 1 3)
        sinfomaxp = (getserver $i 1 4)
        sinfomstr = (getserver $i 1 5)
        sinfovars = (getserver $i 1 6)
        sinfomods = (getserver $i 1 7)
        sinfoofft = (? (>= $sinfolast 0) (div (max (- (getmillis 1) (- $sinfolast (div $sinfoping 2))) 0) 1000) 0)
        sinfoactive = (? (< $sinfoping $serverwaiting) 1 0)
        sinfonumsrv = (? $i (+ $sinfonumsrv $sinfoactive) $sinfoactive)
    ] [1] [
        if $updateservergui [
            guibutton "^fwThere are no servers to display, maybe ^fgupdate ^fwthe list?" updatefrommaster [] "info"
        ] [
            sleep 1 [ updateservergui = 1; updatefrommaster ]
        ]
    ] [
        if (getserver) [ sleep 1 [ updateservers ] ]
        guilist [
            guibutton "^fgupdate"			updatefrommaster;	guistrut 1.5
            guibutton "^frreset"			clearservers;		guistrut 1.5
            guibutton "^fodisconnect"		disconnect;			guistrut 1.5
            guibutton "^fmlan connect"		lanconnect;			guistrut 1.5
            guicheckbox "^fcsearch lan"		searchlan;			guistrut 1.5
            guicheckbox "^fbauto sort"		autosortservers;	guistrut 1.5
            guibutton "^fysort now"			sortservers;		guispring
            guitext (format "^fd[ ^fc%1 ^fwplayers on ^fc%2 ^fwof ^fc%3 ^fwserver%4 ^fd]" $sinfoplayers $sinfonumsrv $sinfonum (? (!= $sinfonum 1) "s"))
            guistrut 1
        ]
        guistrut 0.25
        if (> (getversion 3) (getversion 1)) [
            guilist [ guibutton "^fzoynew version released! ^fwget it now from: ^fcwww.redeclipse.net" "" ]
            guistrut 0.25
        ]
    ] [
        guistrut 0.125
        guimerge 88 [
            guicenter [
                guistrut 10 1
                if $sinfoactive [
                    guicenter [
                        guifont "huge" [ guibutton (format "^fw%1" $sinfonump) ]
                        guifont "default" [ guibutton (format "^fd / ^fa%1" $sinfomaxp) ]
                    ]
                    guicenter [
                        guifont "default" [ guibutton (format "^f%1%2" (? (< $sinfoping 200) "g" (? (< $sinfoping 400) "y" "r")) $sinfoping) ]
                        guifont "reduced" [ guibutton " ^fams" ]
                    ]
                ] [ guicenter [ guifont "huge" [ guispring; guibutton "?"; guispring ] ] ]
            ]
            sinfoimage = "textures/emblem"
            if (&& [< $sinfoping $serverwaiting] [= $sinfogver (getversion 1)]) [
                sinfopath = (listfind curmap $maplist [|| [=s $curmap $sinfomapn] [=s [base/@curmap] $sinfomapn] [
                    && [> $hasoctapaks 0] [=s [base/@curmap] $sinfomapn]
                ]])
                if (> $sinfopath -1) [ sinfoimage = (at $mappath $sinfopath) ]
            ]
            guiimage $sinfoimage "" 2 1 "textures/emblem"
            guistrut 1
            guicenter [
                guilist [
                    guifont "reduced" [ guibutton (format "^fw%1 " $sinfodesc) ]
                    guifont "little" [
                        guibutton (format "^fd(^fa%1^fd)" $sinfonpid)
                        guibutton (format " %1modified" (? $sinfomods (format "^fc%1%% " (precf (*f (divf $sinfomods $sinfovars) 100) 2)) "^fgun"))
                    ]
                ]
                guispring
                if $sinfoactive [
                    guilist [
                        guistrut 0.25
                        if (= $sinfogver (getversion 1)) [
                            guifont "default" [
                                case $sinfostat 0 [
                                    guibutton "^fgopen" [] [] "textures/servers/default"
                                ] 1 [
                                    guibutton "^fylock" [] [] "textures/servers/locked"
                                ] 2 [
                                    guibutton "^fmpriv" [] [] "textures/servers/private"
                                ] 3 [
                                    guibutton "^frfull" [] [] "textures/servers/full"
                                ] () [
                                    guibutton "^founknown" [] [] "textures/servers/unknown"
                                ]
                            ]
                            if (!= $sinfomode $modeidxediting) [
                                guifont "reduced" [ guibutton (format " ^fd[^fw%1^fd]" (timetostr (? $sinfonump (max (- $sinfotime $sinfoofft) 0) $sinfotime) 2)) ]
                            ]
                            gname = (gamename $sinfomode $sinfomuts)
                            if (> (strlen $gname) 32) [ gname = (gamename $sinfomode $sinfomuts 1) ]
                            guifont "little" [ guibutton (format " ^fy%1 ^faon ^fo%2" $gname $sinfomapn) ]
                        ] [
                            guifont "default" [ guibutton "^foincompatible" [] [] "textures/servers/failed" ]
                            guifont "reduced" [ guibutton (concat " ^faserver is using" (? (> $sinfogver (getversion 1)) "a ^fwnewer" "an ^fdolder") "protocol") ]
                        ]
                    ]
                    guispring
                    guilist [
                        if (=s $sinfonpid $sinforetry) [
                            if (= $sinfostat 3) [ guibutton "^fd[ ^fwwaiting for slot ^fd] " ]
                            guibutton "^fwpassword ^fd= "
                            sinfopassval = $sinfopass
                            guifield sinfopassval 20 [sinfopass = $sinfopassval]
                        ] [
                            if (> $sinfonump 0) [
                                guistrut 0.25
                                sinfopnum = (getserver $i 2)
                                if (> $sinfopnum 0) [
                                    guifont "reduced" [ guibutton (format "^fc%1 ^fwplayer%2: " $sinfopnum (? (> $sinfopnum 1) "s")) ]
                                    pname = ""
                                    pmore = 0
                                    loop j $sinfopnum [
                                        if (> (strlen $pname) 86) [ pmore = (+ $pmore 1) ] [
                                            append pname (format ["%1"] (getserver $i 2 $j))
                                        ]
                                    ]
                                    guifont "little" [
                                        guibutton (concat (prettylist $pname) (
                                            ? $pmore (concat "and^fy" $pmore "^fwmore")
                                        ))
                                    ]
                                ] [ guifont "reduced" [ guibutton "^faplayer info not available" ] ]
                            ] [ guifont "reduced" [ guibutton "^fano players online" ] ]
                        ]
                    ]
                ] [
                    guilist [
                        guistrut 0.25
                        guifont "default" [ guibutton "^founresponsive" [] [] "textures/servers/failed" ]
                        guifont "reduced" [ guibutton " ^faserver is not replying to queries" ]
                    ]
                ]
            ]
        ] [
            sinfopass = ""
            sinforetry = @(escape $sinfonpid)
            sinfowait = (! (|| [hasauthkey] [!= @@sinfomstr 4]))
        ] [
            sinfopass = ""
            sinforetry = @(escape $sinfonpid)
            sinfowait = (! (hasauthkey))
        ]
        if (=s $sinfonpid $sinforetry) [
            if (= $sinfowait 1) [
                if (strlen $sinfopass) [
                    connect $sinfoname $sinfoport $sinfopass
                    sinfopass = ""
                    sinforetry = ""
                    sinfowait = 0
                ]
            ] [
                if (|| [hasauthkey] [!= $sinfostat 3]) [
                    connect $sinfoname $sinfoport
                    sinfopass = ""
                    sinforetry = ""
                    sinfowait = 0
                ]
            ]
        ]
        guistrut 0.125
    ] [
    guistrut 0.5
        guilist [
            guifont "little" [
                guitext "sort: "
                loop i (listlen $serversort) [
                    sinfostype = (at $serversort $i)
                    if $sinfostype [
                        sinfosabsl = (? (> $sinfostype 0) $sinfostype (- 0 $sinfostype))
                        sinfosname = (at $sinfotypes $sinfosabsl)
                        guistrut 1
                        guibutton (? (> $sinfostype 0) $sinfosname [-@sinfosname]) [
                            sinfomodify @sinfostype
                        ] [
                            sinfomodify (- 0 @sinfostype)
                        ] "" 0xFFFFFF
                    ]
                ]
                guispring
                loop i (listlen $sinfotypes) [
                    if (&& $i [< (listfind sinfoctype $serversort [= $i (? (> $sinfoctype 0) $sinfoctype (- 0 $sinfoctype))]) 0]) [
                        sinfosname = (at $sinfotypes $i)
                        guistrut 1
                        guibutton $sinfosname [
                            sinfomodify @i
                        ] [
                            sinfomodify (- 0 @i)
                        ] "" 0x666666
                    ]
                ]
                guispring
                guibutton "reset" [serversortreset] [serversortreset] "" 0xFF8888
                guistrut 1
            ]
        ]
        guistrut 0.5
        guilist [
            guifont "little" [ guitext "update interval:" ]
            guistrut 2
            guilist [
                guistrut 80 1
                guilistslider serverupdateinterval "1 2 3 4 5 10 15 20 25 30 35 40 45 50 55 60"
            ]
        ]
    ]
]

newgui servers [
    servermenuiter
    guilist [ servermenu ]
] [
    if (= $guipasses 0) [
        servermenuinit
    ]
]

showfileeditor = [
    guinoautotab [
        guieditor $arg1 $arg2 $arg3
        textinit $arg1 $arg1
        guistayopen [
            guilist [
                guibutton "load" [textfocus @arg1; textload @arg1]
                guibar
                guibutton "save" [textfocus @arg1; textsave @arg1]
                guibar
                guibutton "exec" [textfocus @arg1; textexec]
                guibar
                guibutton "copy" [textfocus @arg1; textcopy]
                guibar
                guibutton "paste" [textfocus @arg1; textpaste]
                guibar
                guibutton "select" [textfocus @arg1; textselectall]
                guibar
                guibutton "clear" [textfocus @arg1; textclear]
            ]
        ]
    ]
]

notepadfile = "untitled.txt"

newgui notepad [
    guifield notepadfile -30
    showfileeditor $notepadfile -80 20
]

notepad = [
    if (> $numargs 0) [notepadfile = $arg1]
    showgui notepad
]

newgui pastebuffer [
    guinoautotab [
        guieditor "#pastebuffer" -80 20
        guistayopen [
            guilist [
                guibutton "exec" [textfocus "#pastebuffer"; textexec]
                guibar
                guibutton "clear" [textfocus "#pastebuffer"; textclear]
            ]
        ]
    ]
]

pastebuffer = [showgui pastebuffer]

newgui scratchpad [
    guinoautotab [
        guieditor "#scratchpad" -80 20
        guistayopen [
            guilist [
                guibutton "exec" [textfocus "#scratchpad"; textexec]
                guibar
                guibutton "copy" [textfocus "#scratchpad"; textcopy]
                guibar
                guibutton "paste" [textfocus "#scratchpad"; textpaste]
                guibar
                guibutton "select" [textfocus "#scratchpad"; textselectall]
                guibar
                guibutton "clear" [textfocus "#scratchpad"; textclear]
            ]
        ]
    ]
]

scratchpad = [showgui scratchpad]

efuimatch = [
    match = 1
    if (&& $efuiinsel $match) [
        if (= $efuiinsel 1) [
            match = (insel)
        ] [
            match = (! (insel))
        ]
    ]
    if (&& $efuidotype $match) [
        match = (strcmp (enttype) (at $enttypelist $efuitype))
    ]
    loop i 5 [
        if (&& $[efuidoattr@i] $match) [
            match = (= (entattr $i) $[efuiattr@i])
        ]
    ]
    result $match
]

efuiinsel = 0

efuitype = 0
efuiattr0 = 0
efuiattr1 = 0
efuiattr2 = 0
efuiattr3 = 0
efuiattr4 = 0

efuidotype = 1
efuidoattr0 = 1
efuidoattr1 = 1
efuidoattr2 = 1
efuidoattr3 = 1
efuidoattr4 = 1

newgui entfind [
    guitext "set the attributes below to search for"
    guistrut 1
    guilist [
        guicheckbox "type	" efuidotype
        guistrut 1
        efuitypename = (at $enttypelist $efuitype)
        guifield efuitypename 11 [efuitypeval = (indexof $enttypelist $efuitypename)
        if (>= $efuitypeval 0) [efuitype = $efuitypeval]]
    ]
    loop i 5 [
        guilist [
            guicheckbox [attr @(+ $i 1)] [efuidoattr@i]
            guistrut 1
            guifield [efuiattr@i] 11 [ efuiattr@i = (+ $efuiattr@i 0)]
        ]
    ]

    guilist [
        guiradio "off" efuiinsel 0
        guistrut 1
        guiradio "inside selection" efuiinsel 1
        guistrut 1
        guiradio "outside selection" efuiinsel 2
    ]

    guibar
    guistayopen [
        guibutton "copy attributes from currently selected entity" [
            loop i 5 [
                [efuiattr@i] = (+ (entattr $i) 0)
                echo [efuiattr@i] = (+ (entattr $i) 0)
            ]
            efuitypeval = (indexof $enttypelist (enttype))
            if (>= $efuitypeval 0) [efuitype = $efuitypeval]
        ]
        guibutton "select all valid entities" [entselect [efuimatch]]
    ]

    guitab type
    guilist [
        loop i (+ (div (listlen $enttypelist) 10) 1) [
            guilist [
                loop j (min (- (listlen $enttypelist) (* 10 $i)) 10) [
                    guiradio (at $enttypelist (+ $j (* $i 10))) efuitype (+ $j (* $i 10))
                ]
            ]
        ]
    ]
]

newmapsize = 12
savemap_name = temp

newgui editing [
    guilist [
        guilist [
            guibutton	"toggle walk / edit mode"				"edittoggle"
            guitext
            guibutton	"open textures menu.."					"showtexgui"
            guibutton	"open this edit menu.."					" "
            guibutton	"open materials menu.."					"showgui materials"
            guibutton	"open console.."						"saycommand /"
            guitext
            guibutton 	"optimize geometry"						"remip"
            guibutton	"patch existing lightmap (patch)"		[fullbright 0; patchlight]
            guibutton	"quick calculate lights (preview)"		[fullbright 0; calclight -1]
            guibutton 	"full calculate lights (full)"			[fullbright 0; calclight 1]
            guitext
            guibutton	"environment settings.."				"showgui environment"
            guitext
            guibutton	"claim privileges.."					"showgui serverpriv"
            guitext
            guibutton 	"send map to server"					"sendmap"
            guibutton	"get map from server"					"getmap"
            guitext
            guibutton	"take screenshot"						[ cleargui; sleep 0 [ screenshot ] ]
        ]
        guilist [
            guitext	"				key F1"
            guitext
            guitext	"				key F2"
            guitext	"				key F3"
            guitext	"				key Numpad 0"
            guitext "				key ~ or /"
            guitext
            guitext	"				key F4"
            guitext	"				key F5"
            guitext	"				key F6"
            guitext	"				key F7"
            guitext
            guitext
            guitext
            guitext
            guitext
            guitext	"				key Insert"
            guitext "				key Delete"
            guitext
            guitext	"				key F12"
        ]
    ]



    guitab file
    guilist [
        guilist [
            guitext
            guitext 	"set map title.."
            guifield 												maptitle 40 [ maptitle $maptitle ]
            guitext 	"set map author.."
            guifield  												mapauthor 40 [ mapauthor $mapauthor ]
            guitext 	"set map filename"
            guifield  												savemap_name 40 [ savemap $savemap_name ]
            guitext
            guibutton	"^foSAVE ^fwmap as filename"				"savemap"
            guitext
            guibutton 	"increase mapsize (2x)"              		"mapenlarge"
            guitext
            guibutton	"start new map"								"showgui newmapgui"
        ]
        guilist [
            guitext
            guitext
            guitext
            guitext
            guitext
            guitext
            guitext
            guitext
            guitext					"key F8"
            guitext
            guitext
            guitext
            guitext
        ]
    ]

    guitab ents
    guilist [
        guilist [
            guibutton	"find ents"				"showgui entfind"
            guitext
            guibutton	"link selected ents (teleport, sound, trigger)"	"showgui entlink"
            guitext
            guibutton	"focus on selected ent"									"entautoview"
            guibutton	"deselect all ents"										"entcancel"
            guibutton	"edit selected ent"										"selentedit"
            guitext
            guibutton	"select all ents inside selection area"					"entselect insel"
            guibutton	"select all ents matching selected"						"selentfindall"
            guitext
            guitext
            guibutton	"create weapon.."										"showgui createweapon"
            guibutton	"create playerstart"									"saycommand [/newent playerstart 0 0 0 0 0]"
            guibutton	"create light.."										"resetlight;showgui newlight"
            guibutton	"create lightfx.."										"saycommand [/newent lightfx 0 0 0 0 0]"
            guibutton	"create teleport.."										"showgui newteleport"
            guibutton	"create mapmodel"										"saycommand [/newent mapmodel 0 0 0 0 0]"
            guibutton	"create sound"											"saycommand [/newent sound 0 0 0 0 0]"
            guibutton	"create pusher"											"saycommand [/newent pusher 0 90 200 0 0 0]"
            guibutton	"create affinity (flag, bomb)"							"saycommand [/newent affinity 0 0 0 0 0]"
            guibutton	"create actor"											"saycommand [/newent actor 0 0 0 0 0 0 0 0 0]"
            guibutton	"create trigger"										"saycommand [/newent trigger 0 0 0 0 0 0 ]"
            guibutton	"create checkpoint"										"saycommand [/newent checkpoint 0 0 0 0 0 0 ]"
        ]
        guilist [
            guitext
            guitext
            guitext "			key L cycles link modes"
            guitext
            guitext "			key Comma (,) + scroll"
            guitext "			key End"
            guitext	"			key Period (.)"
            guitext
            guitext	"			key N"
            guitext
            guitext
            guitext
            guitext
            guitext
            guitext
            guitext
            guitext
        ]
    ]

    guitab ops
    guilist [
        guilist [
            guibutton	"copy"												"copy"
            guibutton	"paste"												"paste"
            guitext
            guibutton	"mirror geometry per selection orientation"			"flip"
            guibutton	"delete selected ents / geometry"					"
            guibutton	"grab texture from selected face"					"gettex"
            guibutton	"repeat last texture change across entire map"		[allfaces 0; replace]
            guitext
            guibutton	"toggle heightmap mode"								"hmapedit 1"
            guitext
            guibutton	"materials.."										[showgui materials]
            guitext
            guibutton	"waypoints.."										[showgui waypoints]
            guitext
            guibutton	"undo"												"undo"
            guibutton	"redo"												"redo"
            guitext		"undo cache size (default: 5 MB)"
            guislider														"undomegs" 1 10
        ]
        guilist [
            guitext	"	key C"
            guitext	"	key V"
            guitext
            guitext	"	key X"
            guitext	"	key Backspace"
            guitext	"	key J"
            guitext
            guitext
            guitext	"	key H, key Alt exit"
            guitext
            guitext	"	key Numpad 0"
            guitext
            guitext
            guitext
            guitext	"	key Z"
            guitext	"	key I"
            guitext
            guitext
        ]
    ]

    guitab vtex
    guilist [
        guilist [
            guitext "create new version of the selected face texture:"
            guitext ""
            guibutton "color.."													"showgui vcolor"
            guitext
            guibutton "scale.."													"showgui vscale"
            guibutton "rotate / flip.."											"showgui vrotate"
            guibutton "offset texture up or down.."								"showgui voffset"
            guitext
            guibutton "texture scrolling.."										"showgui vscroll"
            guitext
            guibutton "glow color.."											"showgui glowcolor"
            guibutton "specularitiy (gloss).."									"showgui specscale"
            guibutton "hightmap intensity.."									"showgui parallaxscale"
            guitext
            guibutton "texture blend painting.."								"showgui blendmap"
            guitext
            guibutton "^foRESET ^fwselected textures to default"				"vreset"
            guitext
            guibutton "^foRESET ^fwall textures in map"							"showgui texreset"
        ]
    ]

    guitab helpers
    guilist [
        guilist [
            guicheckbox	"toggle edit radar"						[showeditradar]
            guicheckbox	"show material volumes"					"showmat"
            guitext
            guicheckbox	"toggle fullbright"						"fullbright"
            guicheckbox	"toggle wireframe"						"wireframe"
            guicheckbox	"toggle blank geometry"					"blankgeom"
            guicheckbox	"toggle outline"						"outline"
            guibutton	"set outline color.."					"showgui outlinecolor"
            guitext
            guicheckbox	"toggle paste grid"						"showpastegrid"
            guicheckbox	"toggle cursor grid"					"showcursorgrid"
            guicheckbox	"toggle selection grid"					"showselgrid"
            guicheckbox	"snap ents to grid"						"entselsnap"
            guitext
            guicheckbox	"toggle allfaces texture mode"			"allfaces"
            guitext
            guitext 	"adjust your float speed (0-1000)"
            guifield  											floatspeed 10 [ floatspeed $floatspeed ]
        ]
        guilist [
            guitext	"					toggle edit radar"
            guitext	"					key M"
            guitext
            guitext	"					key B"
            guitext
            guitext
            guitext	"					key O, F9"
            guitext
            guitext
            guitext	"					key Tab"
            guitext	"					key Tab"
            guitext	"					key Tab"
            guitext
            guitext
            guitext "					key 0"
        ]
    ]


    guitab lightmap
    guilist [
        guilist [
            guitext "lightprecision (default: 32)"
            guitext "^fr(Notice!)^fw Increasing the lightprecision creates a smaller mapfile"
            guilistslider lightprecision "8 16 32 48 64 128 256"
            guitext "lighterror (default: 8)"
            guislider lighterror
            guitext "lightthreads (CPU threads/cores) (default: 0)"
            guislider lightthreads
            guitext
            guibutton "set min light level / shadow color (ambient)..."                   "showgui environment 2"
            guitext
            guibutton "optimize geometry"												"remip"
            guibutton "patch existing lightmap (patch)"									[fullbright 0; patchlight]
            guibutton "quick calculate lights (preview)"								[fullbright 0; calclight -1]
            guibutton "full calculate lights (full)"									[fullbright 0; calclight 1]
        ]
        guilist [
            guitext
            guitext
            guitext
            guitext
            guitext
            guitext
            guitext
            guitext
            guitext
            guitext "		key F4"
            guitext "		key F5"
            guitext "		key F6"
            guitext "		key F7"
        ]
    ]

    guitab keyref
    guilist [
        guilist [
            guitext "change gridsize"
            guitext "select"
            guitext "extend selection / select additional ents"
            guitext	"move selection area / move selected ents"
            guitext	"deselect all"
            guitext	"orient selection face"
            guitext	"create /destroy cubes"
            guitext	"push / pull selected faces"
            guitext	"push / pull corner"
            guitext "select multiple corners"
            guitext	"move selected geometry"
            guitext	"copy"
            guitext	"paste"
            guitext	"rotate geometry per selection orientation"
            guitext	"mirror geometry per selection orientation"
            guitext	"quick texture selected faces"
            guitext	"grab texture from selected faces"
            guitext "change properties of selected ents"
            guitext	"cycle link modes for selected ents"
            guitext	"change brush type"
        ]
        guilist [
            guitext "	hold key G + scroll wheel"
            guitext "	drag left mouse button"
            guitext "	right mouse button"
            guitext "	right mouse button"
            guitext "	key Space"
            guitext "	right mouse button"
            guitext "	scroll mouse wheel"
            guitext "	hold key F + scroll mouse wheel"
            guitext "	hold key Q + scroll wheel"
            guitext "	drag middle mouse button"
            guitext "	hold key U + drag right mouse button"
            guitext "	key C"
            guitext "	key V"
            guitext "	hold key R + scroll mouse wheel"
            guitext "	key X"
            guitext "	hold key Y + scroll mouse wheel"
            guitext "	key J"
            guitext "	hold number keys 1-9 + scroll mouse wheel"
            guitext	"	key L"
            guitext "	hold key K + scroll mouse wheel"
        ]
    ]

    guitab cfg
    guitext [@[mapname].cfg]
    showfileeditor [@[mapname].cfg] -80 20
]









newgui serverpriv [
    guistayopen [
        guiradio	"veto server"					openservertype 0	[serveropen 3]
        guiradio	"open server"					openservertype 1	[serveropen 1]
        guiradio	"coop server"					openservertype 2	[serveropen 2]
        guitext
        guibutton	"claim privileges"				"setpriv 1"
        guibutton	"relinquish privileges"			"setpriv 0"
        guitext
        guibutton	"administrator password"		"saycommand [/adminpass ]"
    ]
]

newgui waypoints [
        guicheckbox	"show waypoints"							"showwaypoints"
        guicheckbox	"create waypoints"							"dropwaypoints"
        guiradio	"gamespeed 100% (default)"					gamespeedtype 0	[gamespeed 100]
        guiradio	"gamespeed 200% (faster waypointing)"		gamespeedtype 1	[gamespeed 200]
        guiradio	"gamespeed 75% (slower waypointing)"		gamespeedtype 2	[gamespeed 75]
        guitext
        guibutton	"add bot"									"addbot"
        guibutton	"remove bot"								"delbot"
        guitext
        guibutton	"^foSAVE ^fwwaypoints"						"savewaypoints"
        guibutton	"^foLOAD ^fwwaypoints"						"saycommand [/loadwaypoints ]"
        guibutton	"^foSAVE ^fwmap"							"savemap"
        guibutton	"^foCLEAR ^fwwaypoints in selection area"	"saycommand [/delselwaypoints]"
        guibutton	"^foCLEAR ^fwall waypoints"					"saycommand [/clearwaypoints]"
]
newgui createweapon [
        guilist [
            guilist [
            guitext	"^fo/newent weapon ^fy#"
            guibutton "sword"			"newent weapon 2"
            guibutton "shotgun"			"newent weapon 3"
            guibutton "smg"				"newent weapon 4"
            guibutton "flamer"			"newent weapon 5"
            guibutton "plasma"			"newent weapon 6"
            guibutton "rifle"			"newent weapon 7"
            guibutton "grenade"			"newent weapon 8"
            guibutton "rocket"			"newent weapon 9
            ]
            guilist [
            guitext
            guitext "weapon 2"
            guitext "weapon 3"
            guitext "weapon 4"
            guitext "weapon 5"
            guitext "weapon 6"
            guitext "weapon 7"
            guitext "weapon 8"
            guitext "weapon 9"
            ]
        ]
]



newgui newmapgui [
        guibutton 	"^foREVERT ^fwto last saved version of @savemap_name"   	"map $savemap_name"
        guitext
        guibutton	"^foOPEN ^fwan existing map"								"showgui maps 1"
        guitext
        guibutton 	"^foCLEAR MAP ^fwand begin a new one ^fr(Warning!)"         "newmap $newmapsize"
        guitext		"size of new map"
        guislider 	"newmapsize" 10 16
]

newgui outlinecolor [
            guiradio	"white"					outlinetype 1 [outlinecolour 255 255 255]
            guiradio	"black"					outlinetype 2 [outlinecolour 0 0 0]
            guiradio	"blue"					outlinetype 3 [outlinecolour 80 80 255]
            guiradio	"red"					outlinetype 4 [outlinecolour 255 80 80]
            guiradio	"green"					outlinetype 5 [outlinecolour 80 255 80]
            guiradio	"yellow"				outlinetype 6 [outlinecolour 255 255 80]
            guitext
            guicheckbox	"toggle outline"		"outline"
]


newgui entlink [
    guistayopen [
    guitext "^fo/entlink ^fw cycles link modes of selected ents"
    guitext
    guibutton 	"cycle linkmode +			key L"					"entlink"
    guitext
    guitext 	"link modes:"
    guitext		"1. A     B
    guitext 	"2. ^frA >> B"
    guitext		"3. ^fyA <> B"
    guitext 	"4. ^frA << B"
    guitext
    guibutton	"create new teleport" 									"saycommand [/newent teleport -1 0 0 0 655 0]"
    guibutton	"create new sound"										"saycommand [/newent sound 0 0 0 0 0]"
    guibutton	"create new trigger"									"saycommand [/newent trigger 0 0 0 0 0 0 0]"
    ]


]


newgui vcolor [
    guistayopen [
        guitext "^fo/vcolor ^fr%R ^fg%G ^fb%B"
        guitext
        guibutton "red"				"saycommand [/vcolor 1.0 0.3 0.3]"
        guibutton "green"			"saycommand [/vcolor 0.3 1.0 0.3]"
        guibutton "blue"			"saycommand [/vcolor 0.3 0.3 1.0]"
        guibutton "orange"			"saycommand [/vcolor 1.0 0.6 0.2]"
        guibutton "yellow"			"saycommand [/vcolor 1.0 0.8 0.3]"
        guibutton "purple"			"saycommand [/vcolor 0.5 0.2 0.7]"
        guibutton "turquoise"		"saycommand [/vcolor 0.1 0.8 0.8]"
        guibutton "dark"			"saycommand [/vcolor 0.3 0.3 0.3]"
        guibutton "white"			"saycommand [/vcolor 1.0 1.0 1.0]"
    ]
]

newgui vscale [
    guistayopen [
    guitext "^fo/vscale ^fy% ^fw(0.125 - 8.0)"
    guitext
    guibutton "12.5%"		"saycommand [/vscale .125]"
    guibutton "25%"			"saycommand [/vscale .25]"
    guibutton "50%"			"saycommand [/vscale .5]"
    guibutton "75%"			"saycommand [/vscale .75]"
    guibutton "100%"		"saycommand [/vscale 1]"
    guibutton "150%"		"saycommand [/vscale 1.5]"
    guibutton "400%"		"saycommand [/vscale 4]"
    guibutton "800%"		"saycommand [/vscale 8]"
    ]
]

newgui vrotate [
    guistayopen [
        guitext "^fo/vrotate ^fy# ^fy(1-3 rotate, 4-5 flip)"
        guitext
        guibutton "rotation/flip +"					"vdelta vrotate 1"
        guibutton "rotation/flip -"					"vdelta vrotate -1"
        guitext
        guibutton "rotate 90"						"saycommand [/vrotate 1]"
        guibutton "rotate 180"						"saycommand [/vrotate 2]"
        guibutton "rotate 270"						"saycommand [/vrotate 3]"
        guitext
        guibutton "flip vertical"					"saycommand [/vrotate 4]"
        guibutton "flip horizontal"					"saycommand [/vrotate 5]"
        guitext
        guibutton "^foRESET ^fwto 0"				"saycommand [/vrotate 0]"
    ]
]

newgui specscale [
    guitext "^fo/vdelta vshaderparam specscale ^fr%R ^fg%G ^fb%B"
    guitext
    guibutton "red gloss"				"saycommand [/vdelta vshaderparam specscale 1.0 0.3 0.3]"
    guibutton "green gloss"				"saycommand [/vdelta vshaderparam specscale 0.3 1.0 0.3]"
    guibutton "blue gloss"				"saycommand [/vdelta vshaderparam specscale 0.3 0.3 1.0]"
    guibutton "orange gloss"			"saycommand [/vdelta vshaderparam specscale 1.0 0.6 0.2]"
    guibutton "yellow gloss"			"saycommand [/vdelta vshaderparam specscale 1.0 0.8 0.3]"
    guibutton "purple gloss"			"saycommand [/vdelta vshaderparam specscale 0.5 0.2 0.7]"
    guibutton "turquoise gloss"			"saycommand [/vdelta vshaderparam specscale 0.1 0.8 0.8]"
    guibutton "50% gloss (subtle)"		"saycommand [/vdelta vshaderparam specscale 0.5 0.5 0.5]"
    guibutton "no gloss (matte)"		"saycommand [/vdelta vshaderparam specscale 0.0 0.0 0.0]"
    guitext
    guibutton "^foRESET ^fwto 100%"		"saycommand [/vdelta vshaderparam specscale 1.0 1.0 1.0]"
]

newgui glowcolor [
    guitext "^fo/vdelta vshaderparam glowcolor ^fr%R ^fg%G ^fb%B"
    guitext
    guibutton "red"						"saycommand [/vdelta vshaderparam glowcolor 1.0 0.3 0.3]"
    guibutton "green"					"saycommand [/vdelta vshaderparam glowcolor 0.3 1.0 0.3]"
    guibutton "blue"					"saycommand [/vdelta vshaderparam glowcolor 0.3 0.3 1.0]"
    guibutton "orange"					"saycommand [/vdelta vshaderparam glowcolor 1.0 0.6 0.2]"
    guibutton "yellow"					"saycommand [/vdelta vshaderparam glowcolor 1.0 0.8 0.3]"
    guibutton "purple"					"saycommand [/vdelta vshaderparam glowcolor 0.5 0.2 0.7]"
    guibutton "turquoise"				"saycommand [/vdelta vshaderparam glowcolor 0.1 0.8 0.8]"
    guitext
    guibutton "^foRESET ^fwto 100%"		"saycommand [/vdelta vshaderparam glowcolor 1.0 1.0 1.0]"
]

newgui parallaxscale [
    guitext "^fo/vdelta vshaderparam parallaxscale ^fr%R ^fg%G ^fb%B"
    guitext
    guibutton "flat"								"saycommand [/vdelta vshaderparam parallaxscale 0.0 0.0 0.0]"
    guibutton "extreme"								"saycommand [/vdelta vshaderparam parallaxscale 0.0025 0.0025 0.0025]"
    guibutton "another dimension"					"saycommand [/vdelta vshaderparam parallaxscale 1.0 1.0 1.0]"
    guitext
    guibutton "^foRESET ^fwto default"				"saycommand [/vdelta vshaderparam parallaxscale 0.0000025 0.0000025 0.0000025]"
]

newgui vscroll [
    guistayopen [
        guitext 	"^fo/vscroll ^fyX Y"
        guitext
        guibutton 	"scroll Y +"			"vdelta vscroll 0 +0.1"
        guibutton 	"scroll Y -"			"vdelta vscroll 0 -0.1"
        guitext
        guibutton 	"scroll X +"			"vdelta vscroll +0.1 0"
        guibutton 	"scroll X -"			"vdelta vscroll -0.1 0"
        guitext
        guibutton 	"^foRESET ^fwto 0"			"saycommand [/vscroll 0 0]"
    ]
]

newgui voffset [
    guistayopen [
        guitext "^fo/voffset ^fyXpx Ypx"
        guitext
        guibutton 	"offset Y +"			"vdelta voffset 0 +16"
        guibutton 	"offset Y -"			"vdelta voffset 0 -16"
        guitext
        guibutton 	"offset X +"			"vdelta voffset +16 0"
        guibutton 	"offset X -"			"vdelta voffset -16 0"
        guitext
        guibutton 	"^foRESET ^fwto 0"			"saycommand [/voffset 0 0]"
    ]
]

newgui blendmap [
    guilist [
        guilist [
            guilist [
                guilist [
                    guistayopen [
                        guitext "assign a blend layer to selected texture:
                        guitext "^fo/vlayer ^fy# ^fw(slot number)"
                        guitext
                        guilist [
                            guistrut 0
                            guitext "texture slot number: "
                            guifield slotnum -8
                        ]
                        guibutton "^foADD ^fwabove brush" [vlayer $slotnum]
                        guibutton "^foREMOVE ^fwabove brush" [vlayer ""]
                    ]
                ]
            ]
            guibutton "open textures menu.." [showtexgui]
            guitext
            guistayopen [
                guibutton "cycle blend paint modes" [
                    hmapedit 0
                    blendpaintmode (? (= $blendpaintmode 5) 0 (+ $blendpaintmode 1))
                    echo (concat "^fgblend mode:^fw" (at $paintmodes $blendpaintmode))
                ]
                guibutton "blend mode off" [blendpaintmode 0]
                guilist [
                    guibutton "cycle paint brush: " [nextblendbrush -1]
                    guitext (getblendbrushname (curblendbrush))
                ]
                guitext
                guibutton "generate preview" showblendmap
                guitext
                guibutton "^foCLEAR ^fwBlendmap" clearblendmap
            ]
        ]
        guilist [
            guitext
            guitext
            guitext
            guitext
            guitext
            guitext
            guitext "	key F2"
            guitext
            guitext "	key P"
            guitext	"	key Alt"
            guitext	" 	scroll mouse wheel"
            guitext
            guitext
            guitext
        ]
    ]
]

newgui texreset [
    guilist [
        guilist [
        guibutton "^foCLEAR ^fwall unused textures from map cfg" [saycommand /texturecull]
        guibutton "^foCLEAR ^fwall textures from map cfg" [saycommand /texturereset]
        guibutton "^foLOAD ^fwdefault texture package to map cfg (reload map required)" [saycommand /exec data/textures.cfg]
        ]
    ]
]

newgui environment [
    guistayopen [
    guitext			"quick global lighting:"
    guitext
    guibutton		"night"										[ambient 40 40 40; skylight 70 80 90; skybox skyboxes/stars; skycolour 255 255 255; cloudlayer skyboxes/clouds01; cloudlayercolour 50 60 100; cloudlayerblend 0.3; cloudscrollx 0.005; fogcolour 12 10 13; fog 2000; calclight -1]
    guibutton		"morning"									[ambient 60 35 40; skylight 170 140 145; skybox penguins/harmony; skycolour 255 160 180; cloudlayer skyboxes/clouds03; cloudlayercolour 255 125 170; cloudlayerblend 0.2; cloudscrollx 0.01; fogcolour 129 79 59; fog 2000; calclight -1]
    guibutton		"evening"									[ambient 50 30 10; skylight 180 100 70; skybox skyboxes/sunsetflat; skycolour 255 255 255; cloudlayer skyboxes/clouds01; cloudlayercolour 255 100 50; cloudlayerblend 0.2; cloudscrollx 0.005; fogcolour 40 20 5; fog 2000; calclight -1]
    guitext
    guibutton		"^foRESET ^fwenvironment to default"		[ambient 0 0 0; skylight 0 0 0; skybox ""; skycolour 255 255 255; cloudlayer ""; cloudlayercolour 255 255 255; cloudlayerblend 1.0; cloudscrollx 0; fogcolour 128 153 179; fog 4000; calclight -1]

    guitab ambient
    guitext			"^fo/ambient ^frR ^fgG ^fbB"
    guibutton		"grey shadows"								"saycommand [/ambient 40 40 40]"
    guibutton		"purple shadows"							"saycommand [/ambient 60 35 40]"
    guibutton		"brown shadows"								"saycommand [/ambient 50 30 10]"
    guitext
    guibutton		"^foRESET ^fwambient to default"			"saycommand [/ambient 0 0 0]"

    guitab skylight
    guitext			"^fo/skylight ^frR ^fgG ^fbB"
    guibutton		"cool skylight"								"saycommand [/skylight 70 80 90]"
    guibutton		"soft skylight"								"saycommand [/skylight 170 140 145]"
    guibutton		"warm skylight"								"saycommand [/skylight 180 100 70]"
    guitext
    guibutton		"^foRESET ^fwskylight to default"			"saycommand [/skylight 0 0 0]"


    guitab fog
        guitext 	"^fo/fog ^fy#"
        guibutton 	"fog distance far"				"saycommand [/fog 1500]"
        guibutton 	"fog distance distant"			"saycommand [/fog 800]"
        guibutton 	"fog distance near"				"saycommand [/fog 300]"
        guibutton 	"^foRESET ^fwfog distance"		"saycommand [/fog 4000]"
        guitext
        guitext
        guitext 	"^fo/fogcolour ^frR ^fgG ^fbB"
        guibutton 	"black fog (darkness)"				"saycommand [/fogcolour 0 0 0]"
        guibutton 	"grey fog (haze)"					"saycommand [/fogcolour 50 50 50]"
        guibutton 	"green fog (gas)"					"saycommand [/fogcolour 40 60 45]"
        guibutton 	"^foRESET ^fwfog color to default"	"saycommand [/fogcolour 128 153 179]"

    guitab skybox
        guitext 	"^fo/skybox ^fyfolder/filename"
        guibutton 	"set skybox to skyhigh"			"saycommand [/skybox skyboxes/skyhigh]"
        guibutton 	"set skybox to sunsetflat"		"saycommand [/skybox skyboxes/sunsetflat]"
        guibutton	"set skybox to gradient"		"saycommand [/skybox skyboxes/gradient]"
        guibutton 	"^foREMOVE ^fwskybox"  			[saycommand "/skybox ^"^""]
        guitext
        guitext
        guitext		"^fo/skycolour ^frR ^fgG ^fbB"
        guibutton	"set sky color to orange"		"saycommand [/skycolour 255 150 20]"
        guibutton	"set sky color to yellow"		"saycommand [/skycolour 150 150 80]"
        guibutton	"set sky color to red"			"saycommand [/skycolour 180 80 80]"
        guibutton	"set sky color to blue"			"saycommand [/skycolour 80 80 180]"
        guibutton	"set sky color to black"		"saycommand [/skycolour 80 80 80]"
        guibutton 	"^foRESET ^fwsky color"			"saycommand [/skycolour 255 255 255]"

    guitab clouds
        guitext 	"^fo/cloudlayer ^fyfolder/filename"
        guibutton 	"set clouds to clouds01"			"saycommand [/cloudlayer skyboxes/clouds01]"
        guibutton 	"set clouds to clouds02"			"saycommand [/cloudlayer skyboxes/clouds02]"
        guibutton 	"set clouds to clouds03"			"saycommand [/cloudlayer skyboxes/clouds03]"
        guibutton 	"^foREMOVE ^fwcloudlayer" 			[saycommand "/cloudlayer ^"^""]
        guitext
        guitext
        guitext		"^fo/cloudlayercolour ^frR ^fgG ^fbB"
        guibutton	"set cloud color to orange"		"saycommand [/cloudlayercolour 255 150 20]"
        guibutton	"set cloud color to yellow"		"saycommand [/cloudlayercolour 150 150 80]"
        guibutton	"set cloud color to red"		"saycommand [/cloudlayercolour 180 80 80]"
        guibutton	"set cloud color to blue"		"saycommand [/cloudlayercolour 80 80 180]"
        guibutton	"set cloud color to black"		"saycommand [/cloudlayercolour 80 80 80]"
        guibutton 	"^foRESET ^fwcloud color"		"saycommand [/skycolour 255 255 255]"

        guitab vars
        guitext	"^fo/gravity ^fy%"
        guibutton	"none"								"saycommand	[/gravity 5.0]"
        guibutton	"low"								"saycommand [/gravity 15.0]"
        guibutton	"default"							"saycommand [/gravity 50.0]"
        guitext

        guitext "^fo/spawnweapon ^fy#"
        guilist [
            guilist [
            guibutton "sword"			"saycommand	[/spawnweapon 2]"
            guibutton "shotgun"			"saycommand	[/spawnweapon 3]"
            guibutton "smg"				"saycommand	[/spawnweapon 4]"
            guibutton "flamer"			"saycommand	[/spawnweapon 5]"
            ]

            guilist [
            guibutton "			plasma"				"saycommand	[/spawnweapon 6]"
            guibutton "			rifle"				"saycommand	[/spawnweapon 7]"
            guibutton "			grenade"			"saycommand	[/spawnweapon 8]"
            guibutton "			rocket"				"saycommand	[/spawnweapon 9]"
            ]
        ]
            guitext
            guitext	"^foplayer vars"
            guibutton "maximum inventory (default 2)"		"saycommand [/maxcarry 9]"
            guibutton "jumpspeed (default 100)" 			"saycommand [/jumpspeed 200]"
            guibutton "impulse freestyle (default 1)"		"saycommand [/impulsestyle 3]"

    guibutton "show all variables.."			"showgui vars"

    ]
]
resetlight = [
    lightcolour = 0
    lightrgb = "255 255 255"
    lightbright = 1
    lightradius = 128
]

lightcmd = [
    lightr = (at $lightrgb 0)
    lightg = (at $lightrgb 1)
    lightb = (at $lightrgb 2)
    if (! $lightbright) [
        if (=s $lightrgb "255 255 255") [
            lightr = 192; lightg = 192; lightb = 192
        ] [
            lightr = (div $lightr 2); lightg = (div $lightg 2); lightb = (div $lightb 2)
        ]
    ]
    result (concat newent light $lightradius $lightr $lightg $lightb)
]

newgui newlight [
    guibutton "create a sunlight entity          " "saycommand [/newent sunlight 45 320 100 70 50]"
    guitext
    guitext "light radius:"
    guislider lightradius 0 800
    guiradio "white"       						lightcolour 0 [lightrgb = "150 150 150"]
    guiradio "blue"         					lightcolour 1 [lightrgb = "80 80 180"]
    guiradio "red"          					lightcolour 2 [lightrgb = "180 80 80"]
    guiradio "green"        					lightcolour 3 [lightrgb = "80 180 80"]
    guiradio "yellow"       					lightcolour 4 [lightrgb = "150 150 80"]
    guiradio "purple"       					lightcolour 5 [lightrgb = "150 80 150"]
    guiradio "turquoise"    					lightcolour 6 [lightrgb = "80 150 150"]
    guitext
    guicheckbox "bright"    					lightbright
    guitext
    guibutton "^foCREATE" (lightcmd)
    guibutton (lightcmd)
]


newgui newteleport [
	guitext "^fo/newent teleport ^fwlink teleports with ^fo/entlink ^fw(key L)"
    guitext
	guibutton "create a new teleport" 			"saycommand [/newent teleport -1 0 0 0 655 0]"
]

macro resbutton [
    guibutton "%1x%2" "screenres %1 %2" [] (? (&& [= $scr_w %1] [= $scr_h %2]) "radioboxon" "radiobox")
]



newgui options [
    guiautotab 15
    guitext "performance key: ^fgfast^f~, ^fymoderate^f~, ^foslow and pretty^f~"
    guibar
    if (&& [< $shaders 0] [= $renderpath 0]) [
        guicheckbox "^fyshaders         "           shaders 1 -1
    ] [
        guilist [
            guicheckbox "^fyshaders			"           shaders
            if $shaders [
                guibar
                guiradio "^fglow detail " shaderdetail 1
                guiradio "^fyhigh detail " shaderdetail 3
                //if $hasglsl [
                //    guicheckbox "^foGLSL only" forceglsl
                //]
            ]
        ]
    ]
    guilist [
        guitext "water			" blank
        guibar
        guicheckbox "^fyrefraction "  waterrefract
        guicheckbox "^foreflection "  waterreflect
        guicheckbox "^fgcaustics "    caustics
    ]
    if (> $renderpath 0) [
        guilist [
            guitext "waterfalls			" blank
            guibar
            guicheckbox "^fyrefraction " waterfallrefract
            guicheckbox "^fgreflection " waterfallenv
        ]
    ]
    if (= $renderpath 0) [
        guilist [
            guicheckbox "^foshadow maps		"  shadowmap
            if $shadowmap [
                guibar
                guiradio "^fymedium quality " shadowmapsize 9 [blurshadowmap 1]
                guiradio "^fohigh quality " shadowmapsize 10 [blurshadowmap 2]
            ] [
                guibar
                guicheckbox "^fgblob shadows " blobs
            ]
        ]
        if (>= $maxtmus 3) [
            guicheckbox "^fydynamic lights"    ffdynlights 5 0
        ]
    ] [
        guilist [
            guicheckbox "^fosoft shadows		"  shadowmap
            if $shadowmap [
                guibar
                guiradio "^fymedium quality " shadowmapsize 9 [blurshadowmap 1]
                guiradio "^fohigh quality " shadowmapsize 10 [blurshadowmap 2]
            ] [
                guibar
                guicheckbox "^fgblob shadows " blobs
            ]
        ]
        if $glare [
            glarepreset = 0
            if (= $glarescale 1) [
                if (= $blurglare 4) [glarepreset = 1]
                if (= $blurglare 7) [glarepreset = 3]
            ]
            if (= $glarescale 2) [
                if (= $blurglare 3) [glarepreset = 2]
                if (= $blurglare 7) [glarepreset = 4]
            ]
            guilist [
                guicheckbox "^foglare				"       glare
                guibar
                guiradio "^fysubtle " glarepreset 1 [blurglare 4; glarescale 1]
                guiradio "^fyglowy " glarepreset 2 [blurglare 3; glarescale 2]
                guiradio "^fosoft " glarepreset 3 [blurglare 7; glarescale 1]
                guiradio "^fointense " glarepreset 4 [blurglare 7; glarescale 2]
            ]
        ] [
            guicheckbox "^foglare"         glare
        ]
    ]
    if $usetexrect [
        guilist [
            guicheckbox "^fomotion blur		" motionblur
            if $motionblur [
                guibar
                guiradio "^fosubtle " motionblurscale 0.5
                guiradio "^fomoderate " motionblurscale 1
            ]
        ]
    ]
    guilist [
        guicheckbox "^fograss			" grass
        if $grass [
            guibar
            guiradio "^fyquick fade " grassdist 128
            guiradio "^fymoderate fade " grassdist 256
            guiradio "^foslow fade " grassdist 512
        ]
    ]
    if (> $renderpath 0) [
        guilist [
            guicheckbox "^fgdynamic lights		"    maxdynlights 3 0
            if $maxdynlights [
                guibar
                guiradio "^fgmedium quality " maxdynlights 3
                guiradio "^fyhigh quality " maxdynlights 5
            ]
        ]
        guilist [
            guicheckbox "^fysoft particles		" depthfx
            if $depthfx [
                guibar
                guiradio "^fglow quality " depthfxsize 7 [depthfxrect 0; depthfxfilter 1; blurdepthfx 1]
                guiradio "^fymedium quality " depthfxsize 10 [depthfxrect 1; depthfxfilter 0; blurdepthfx 0]
                guiradio "^fohigh quality " depthfxsize 12 [depthfxrect 1; depthfxfilter 0; blurdepthfx 0]
            ]
        ]
    ]
    guicheckbox "^fgglass reflection"  glassenv
    guilist [
        guicheckbox "^fgdecals			" decals
        if $decals [
            guibar
            guiradio "^fgmedium quality " maxdecaltris 1024
            guiradio "^fyhigh quality " maxdecaltris 4096
        ]
    ]
    guicheckbox "^fgfix t-joints (world sparklies)" filltjoints
    guilist [
        guitext "textures			" blank
        guibar
        guiradio "^fglow quality " maxtexsize 256
        guiradio "^fgmedium quality" maxtexsize 512
        guiradio "^fyhigh quality " maxtexsize 0
    ]
    guilist [
        guitext "models			" blank
        guibar
        guicheckbox "^fglighting "    lightmodels
        guicheckbox "^fgreflection "  envmapmodels
        guicheckbox "^fgglow "        glowmodels
        if (> $renderpath 0) [
            guicheckbox "^fybumpmap " bumpmodels
        ]
    ]
    guilist [
        guitext "animation			" blank
        guibar
        guiradio "^fgmedium quality " matskel 1
        guiradio "^fghigh quality " matskel 0
    ]

    guitab    "display"
    guicheckbox "v-sync"            vsync 1 0
    guicheckbox "fullscreen"        fullscreen
    guitext "gamma (default: 100)"
    guislider gamma
    guitext "full-scene anti-aliasing (default: -1)"
    guilistslider fsaa "-1 0 2 4 8 16"
    guitext "color depth (default: 0)"
    guilistslider colorbits "0 8 16 24 32"
    guitext "z-buffer depth (default: 0)"
    guilistslider depthbits "0 8 16 24 32"
    guitext "stencil bits (default: 0)"
    guislider stencilbits
    guitext "anisotropic filtering (default: 0)"
    guilistslider aniso "0 2 4 8 16"

    guitab   "ui"
    guilist [
        guitext "blinking text (default: 250ms, 0 = off): "
        guilist [
            guilist [ guistrut 60 ]
            guilistslider blinkingtext "0 50 100 150 200 250 300 350 400 450 500 550 600 650 700 750 800 850 900 950 1000"
        ]
    ]
    guibar
    guilist [
        guicheckbox "show crosshair " showcrosshair
        guicheckbox "weapon crosshairs " crosshairweapons
        guicheckbox "show clips " showclips
        guicheckbox "show radar " showradar
    ]
    guibar
    guilist [
      guitext "crosshair size (0 - 1000, default: 0.05): "
      crosshairsizestorage = $crosshairsize
      guifield crosshairsizestorage 6 [crosshairsize $crosshairsizestorage]
      guistrut 1
      guitext "zoom crosshair size (0 - 1000, default: 0.575): "
      zoomcrosshairsizestorage = $zoomcrosshairsize
      guifield zoomcrosshairsizestorage 6 [zoomcrosshairsize $zoomcrosshairsizestorage]
    ]
    guibar
    guitext "notice messages"
    guilist [
    guilist [
      guiradio "off" shownotices 0
      guiradio "basic notices" shownotices 1
      guiradio "level 2" shownotices 2
      guiradio "level 3" shownotices 3
      guiradio "everything" shownotices 4
    ]
    guibar
    guilist [
      guitext "fps display"
      guiradio "off" showfps 0
      guiradio "number only" showfps 1
      guiradio "verbose" showfps 2
      guiradio "more verbose" showfps 3
    ]
    ]

    guitab "res"
    guistayopen [
      guilist [
        guilist [
            guitext "4:3"
            @(resbutton 320 240)
            @(resbutton 640 480)
            @(resbutton 800 600)
            @(resbutton 1024 768)
            @(resbutton 1152 864)
            @(resbutton 1280 960)
            @(resbutton 1400 1050)
            @(resbutton 1600 1200)
            @(resbutton 1792 1344)
            @(resbutton 1856 1392)
            @(resbutton 1920 1440)
            @(resbutton 2048 1536)
            @(resbutton 2800 2100)
            @(resbutton 3200 2400)
        ]
        guibar
        guilist [
            guitext "16:10"
            @(resbutton 320 200)
            @(resbutton 640 400)
            @(resbutton 1024 640)
            @(resbutton 1280 800)
            @(resbutton 1440 900)
            @(resbutton 1600 1000)
            @(resbutton 1680 1050)
            @(resbutton 1920 1200)
            @(resbutton 2048 1280)
            @(resbutton 2560 1600)
            @(resbutton 3840 2400)
        ]
        guibar
        guilist [
            guitext "16:9"
            @(resbutton 1024 600)
            @(resbutton 1280 720)
            @(resbutton 1366 768)
            @(resbutton 1600 900)
            @(resbutton 1920 1080)
            @(resbutton 2048 1152)
            @(resbutton 3840 2160)
        ]
        guibar
        guilist [
            guitext "5:4"
            @(resbutton 600 480)
            @(resbutton 1280 1024)
            @(resbutton 1600 1280)
            @(resbutton 2560 2048)
        ]
        guibar
        guilist [
            guitext "5:3"
            @(resbutton 800 480)
            @(resbutton 1280 768)

            guibar
            guitext "Custom"
            guilist [
                customw = $scr_w
                customh = $scr_h
                guifield customw 4 [scr_w $customw]
                guifield customh 4 [scr_h $customh]
            ]
        ]
      ]
    ]

    guitab   "sound"
    guitext "master volume"
    guislider mastervol
    guitext "sound volume"
    guislider soundvol
    guitext "music volume"
    guislider musicvol
    guitext "sound channels"
    guislider soundchans
    guitext "sound frequency"
    guilistslider soundfreq "11025 22050 44100"
    guitext "sound buffer length"
    guislider soundbufferlen
    guilist [
            guilist [
                guitext "in-game music		"
            ]
            guilist [
                guilist [
                    guiradio "off	" 		musictype 0
                    guiradio "mapmusic	" 	musictype 1
                    guiradio "random	" 	musictype 2
                    ]
                ]
            ]
    guilist [
            guilist [
                guitext "edit mode music	"
            ]
            guilist [
                guilist [
                    guiradio "off	" 		musicedit 0
                    guiradio "mapmusic	" 	musicedit 1
                    guiradio "random	" 	musicedit 2
                    ]
                ]
            ]
    guitext
    guicheckbox "mumble positional audio" mumble

    guitab  "mouse"
    guilist [
        guilist [
            guitext "mouse overall sensitivity  "
            guitext "mouse yaw sensitivity"
            guitext "mouse pitch sensitivity"
            guistrut 1
            guicheckbox "invert y-axis" mouseinvert
        ]
        guilist [
            guistrut 50 1
            guislider sensitivity 1 100
            guislider yawsensitivity 0 100
            guislider pitchsensitivity 1 100
        ]
    ]

    guitab  "keys"
    guitext "basic keybinds, for anything more use the 'bind' command"
    guitext "select action to bind and press desired keys (ESC when done):"
    guistrut 1
    guilistsplit n 2 $bindactions [
        guilist [
            guitext (tabify (concatword (at $bindnames $gli) " ") 4)
            [newbinds@gli] = (searchbinds $n)
            guikeyfield [newbinds@gli] -24 [
                oldbinds = (searchbinds [@@n])
                looplist j $oldbinds [bind $j ""]
                looplist j $[newbinds@@gli] [bind $j [@@@n]]
            ]
        ]
    ] [guistrut 2]

    guitab "autoexec.cfg"
    guitext "autoexec.cfg"
    showfileeditor "autoexec.cfg" -80 20
]

newgui postfx [
    guibutton "(effect OFF)"          "clearpostfx"
    guibutton "bloom (subtle: 30%)"    "bloom 0.3"
    guibutton "bloom (bright: 55%)"    "bloom 0.55"
    guibutton "bloom (intense: 80%)"  "bloom 0.8"
    guibutton "rotoscope" "rotoscope 1"
    guibutton "rotoscope + blur3" "rotoscope 1 1"
    guibutton "rotoscope + blur5" "rotoscope 1 2"
    guibutton "sobel"  "setpostfx sobel"
    guibutton "invert" "setpostfx invert"
    guibutton "gbr"    "setpostfx gbr"
    guibutton "bw"     "setpostfx bw"
    guibutton "blur3"  "setpostfx hblur3; addpostfx vblur3"
    guibutton "blur5"  "setpostfx hblur5; addpostfx vblur5"
]

bindactions = [
    forward backward left right "universaldelta 1" "universaldelta -1" "spectator 1" "spectator 0"
    "action 0" "action 1" "action 2" "action 3" "action 4" "action 5" "action 6" "action 7" "action 8" "action 9"
    "weapon 0" "weapon 1" "weapon 2" "weapon 3" "weapon 4" "weapon 5" "weapon 6" "weapon 7" "weapon 8" "weapon 9"
    "saycommand /" saytextcommand sayteamcommand toggleconsole edittoggle takescreenshot
    addbot delbot "showgui maps 1" "showgui maps 2" "setpriv 1" "showgui loadout" "showgui team"
    "showcompass voice" "showcompass team"
]
bindnames = [
    forward backward left right "scroll up" "scroll down" "enter spectator" "exit spectator"
    "attack" "alt-attack" "reload" "use" "jump" "run/walk" "crouch" "special" "drop" "affinity"
    "melee" "pistol" "sword" "shotgun" "smg" "flamer" "plasma" "rifle" "grenade" "rocket"
    "cmd input" "all chat" "team chat" "toggle console" "toggle editing" "screenshot"
    "add bot" "delete bot" "maps menu" "maps voting" "claim privileges" "loadout menu" "team menu"
    "voice compass" "team compass"
]

entupdate = [ entset $tmpt $tmp0 $tmp1 $tmp2 $tmp3 ]

initentgui = [
    tmpt = (enttype)
    @(loopconcat i 4 [result [
        tmp@i = (entattr @i)
    ]])
]

genentattributes = [
    entattributes = ""
    n = (listlen $arg2)
    loop i $n [
        entattributes = (concat $entattributes [
            guitext @(at $arg2 $i)
            guislider tmp@i @(at $arg3 (* 2 $i)) @(at $arg3 (+ 1 (* 2 $i))) entupdate
        ])
    ]
]

guilistsplit = [
    guilist [
        gli = 0
        gll = (listlen $arg3)
        glz = (div (+ $gll (- $arg2 1)) $arg2)
        loop gla $arg2 [
            guilist [
                glt = (min (+ $gli $glz) $gll)
                while [< $gli $glt] [
                    $arg1 = (at $arg3 $gli)
                    if (> $numargs 3) arg4
                    gli = (+ $gli 1)
                ]
            ]
            if (&& (> $numargs 4) (< (+ $gla 1) $arg2)) [arg5]
        ]
    ]
]

guiloopsplit = [
    guilist [
        gli = 0
        glz = (div (+ $arg3 (- $arg2 1)) $arg2)
        loop gla $arg2 [
            guilist [
                glt = (min (+ $gli $glz) $arg3)
                while [< $gli $glt] [
                    $arg1 = $gli
                    if (> $numargs 3) arg4
                    gli = (+ $gli 1)
                ]
            ]
            if (&& (> $numargs 4) (< (+ $gla 1) $arg2)) [arg5]
        ]
    ]
]

quickeditmenu = [
    guitext "Quick Commands:"
    guibar
    guifield  savemap_name 10 [ savemap $savemap_name ]
    guibutton quicklight          "calclight -1"
    guibutton "optimize map"      "remip"
    guibutton "new entity"        "newent light"
    guibar
    guibutton newmap
    guibar
    guibutton help "showgui editing"
]

matmenu = [
    guicheckbox		"show material volumes		   key M"			"showmat"
    guitext
    guibutton	"air							key Numpad 1"					"editmat air"
    guibutton	"alpha						key Numpad 2"						"editmat alpha"
    guibutton	"water						key Numpad 3"						"editmat water"
    guibutton	"lava							key Numpad 4"					"editmat lava"
    guibutton	"clip							key Numpad 5"					"editmat clip"
    guibutton	"noclip						key Numpad 6"						"editmat noclip"
    guibutton	"aiclip						key Numpad 7"						"editmat aiclip"
    guibutton	"death						key Numpad 8"						"editmat death"
    guibutton	"ladder						key Numpad 9"						"editmat ladder"

]

newentgui = [
    genentattributes [@arg1] [@arg2] [@arg3]
    newgui $arg1 [
        guitext $tmpt
        guibar
        @entattributes
        guitab type
        guilistsplit n 2 $enttypelist [
            guibutton $n [ entset @n ]
        ]
    ]
]

looplist i $enttypelist [
    newentgui $i "" ""
]

newgui materials [
    @matmenu

]

newgui quickedit [
    @quickeditmenu
    guitab materials
    @matmenu
]

newentgui light "radius red green blue" "0 400 0 255 0 255 0 255"
newentgui spotlight "radius" "0 200"
newentgui playerstart "yaw team id" "0 360"
newentgui teleport "tag" "0 20"
newentgui teledest "yaw tag" "0 360 0 20"
newentgui monster "yaw type" "0 360 0 7"
newentgui mapmodel "model yaw type tag flags" "360 0 0 100 0 29 0 20"
newentgui envmap "radius" "0 400"
newentgui pusher "Z Y X" "0 200 0 200 0 200"
newentgui carrot "tag type" "0 50 0 29"
newentgui sound "type radius size" "0 20 0 500 0 500"
newentgui particles "type" "0 3"

guilistloop = [
    i = 0
    j = (+ (div $arg3 (* $arg1 $arg2)) 1)
    loop a $j [
        if (> $a 0) [ guitab $a ]
        guilist [
            loop b $arg1 [
                guilist [
                    loop c $arg2 [
                        if (< $i $arg3) [
                            if (> $numargs 3) arg4
                            i = (+ $i 1)
                            if (< $c (- $arg2 1)) [ guibar ]
                        ]
                    ]
                ]
                if (&& (< $i $arg3) (< $b (- $arg1 1))) [ guibar ]
            ]
        ]
    ]
]

alias showmapmodel [
    mapmodelpath = (mapmodelindex $arg1)
    mapmodelshot = (concatword "models/" $mapmodelpath "/thumb")
    mapmodelcmd = (concat newent mapmodel $arg1)
    guilist [ guilist [
        guiimage $mapmodelshot $mapmodelcmd 2 1 "textures/nothumb"
        guibutton $mapmodelpath $mapmodelcmd
    ] ]
]

newgui mapmodels [
    mapmodelnum = (mapmodelindex)
    guilistloop 4 2 $mapmodelnum [ showmapmodel $i ]
]
